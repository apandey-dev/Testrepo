index.html 
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FocusPad | Distraction-Free Editor</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="focus.svg">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..600&family=Inter:wght@400;500;600&family=Merriweather:wght@300;400;700&family=Playpen+Sans:wght@300;400;600&family=Kalam:wght@300;400;700&family=Pacifico&family=Satisfy&family=Poppins:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Dynamic print page size styling for PDF export -->
    <style id="print-page-style">
        @media print {
            @page {
                size: A2 portrait;
                margin: 0;
            }
        }
    </style>

    <!-- Consolidated CSS files -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/theme.css">
</head>

<body data-theme="dark">
    <div id="auth-overlay">
        <div class="auth-loader"
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;">
            <i class="ph ph-spinner-gap" style="font-size: 40px; color: #fff; animation: spin 1s linear infinite;"></i>
            <p style="color: #ccc; font-family: 'Fredoka', sans-serif; font-size: 14px;">Loading...</p>
        </div>

        <div class="auth-box" style="display: none;">
            <div class="auth-header">
                <i class="ph ph-notebook" style="font-size: 48px; color: #fff; margin-bottom: 15px;"></i>
                <h2 id="auth-title">Welcome Back</h2>
                <p id="auth-subtitle">Login to access your private notes</p>
            </div>

            <form id="auth-form" onsubmit="event.preventDefault();">
                <div class="input-group">
                    <i class="ph ph-envelope"></i>
                    <input type="email" id="auth-email" placeholder="Email Address" required>
                </div>
                <div class="input-group">
                    <i class="ph ph-lock-key"></i>
                    <input type="password" id="auth-pass" placeholder="Password" required>
                </div>
                <div id="auth-error" class="auth-error"></div>
                <button type="submit" class="auth-btn" id="auth-submit-btn">Login</button>
            </form>

            <div class="auth-footer">
                <span id="auth-switch-text">Don't have an account?</span>
                <button id="auth-switch-btn" onclick="AuthUI.toggleMode()">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="app-wrapper" style="display: none; height: 100%; flex-direction: column;">

        <div id="sidebar-overlay" onclick="UI.toggleSidebar()"></div>

        <div id="sidebar">
            <div class="sb-header">
                <div class="sb-logo">
                    <i class="ph ph-notebook" style="font-size: 24px; color: var(--text-primary);"></i>
                    <span>FocusPad</span>
                </div>
                <button class="icon-btn" onclick="UI.toggleSidebar()"><i class="ph ph-x"></i></button>
            </div>

            <div class="sb-content">
                <!-- Folders Section -->
                <div class="sb-section-label">Folders</div>
                <div id="folders-list" class="folders-list">
                    <!-- Folders will be rendered here by JS -->
                </div>

                <div class="sb-section-label">All Notes</div>
                <div id="notes-list" class="notes-list">
                    <!-- Notes will be rendered here by JS -->
                </div>
            </div>

            <div class="sb-footer">
                <button class="sb-btn" onclick="UI.openModal('settings')">
                    <i class="ph ph-gear"></i>
                    <span>Settings</span>
                </button>
                <button class="sb-btn" id="btn-install-sidebar" style="display: none;">
                    <i class="ph ph-download-simple"></i>
                    <span>Install App</span>
                </button>
                <button class="sb-btn logout-btn" onclick="Auth.logout()">
                    <i class="ph ph-sign-out"></i>
                    <span>Log Out</span>
                </button>
            </div>
        </div>

        <div id="chips-bar">
            <button class="icon-btn" id="btn-menu" onclick="UI.toggleSidebar()"><i class="ph ph-list"></i></button>
            <div class="chips-scroll" id="chips-scroll-container">
            </div>
            <button class="new-btn" id="new-note-btn">New Note</button>
            <button class="pin-filter-btn" id="pin-filter-btn" onclick="UI.togglePinFilter()"
                title="Show Pinned Notes Only">
                <i class="ph ph-push-pin"></i>
            </button>
            <button class="settings-btn" id="settings-btn" onclick="UI.openModal('settings')" title="Settings">
                <i class="ph ph-gear"></i>
            </button>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal-overlay" class="modal-overlay" style="display: none;">
            <div class="modal settings-modal">
                <div class="modal-header">
                    <h3><i class="ph ph-gear"></i> Settings</h3>
                    <button class="icon-btn" onclick="UI.closeSettingsModal()"><i class="ph ph-x"></i></button>
                </div>
                <div class="settings-content">
                    <div class="settings-section">
                        <h4>Appearance</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <span class="setting-label">Theme</span>
                                <span class="setting-description">Choose between light and dark mode</span>
                            </div>
                            <div class="theme-toggle">
                                <button class="theme-option" data-theme="light" onclick="Settings.setTheme('light')">
                                    <i class="ph ph-sun"></i>
                                    <span>Light</span>
                                </button>
                                <button class="theme-option active" data-theme="dark"
                                    onclick="Settings.setTheme('dark')">
                                    <i class="ph ph-moon"></i>
                                    <span>Dark</span>
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <span class="setting-label">Editor Font</span>
                                <span class="setting-description">Default font for the editor</span>
                            </div>
                            <select class="setting-select" id="editor-font-select">
                                <option value="Playpen Sans">Playpen Sans</option>
                                <option value="Fredoka">Fredoka</option>
                                <option value="Inter">Inter</option>
                                <option value="Kalam">Kalam</option>
                                <option value="Pacifico">Pacifico</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Editor</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <span class="setting-label">Auto-save</span>
                                <span class="setting-description">Automatically save changes</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-save-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <span class="setting-label">Font Size</span>
                                <span class="setting-description">Default editor font size</span>
                            </div>
                            <select class="setting-select" id="font-size-select">
                                <option value="14">Small (14px)</option>
                                <option value="16" selected>Medium (16px)</option>
                                <option value="18">Large (18px)</option>
                                <option value="20">Extra Large (20px)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn btn-secondary" onclick="UI.closeSettingsModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Chip Context Menu -->
        <div class="chip-context-menu" id="chip-context-menu" style="display: none;">
            <div class="context-menu-item" data-action="rename">
                <i class="ph ph-pencil-simple"></i>
                <span>Rename</span>
            </div>
            <div class="context-menu-item" data-action="pin">
                <i class="ph ph-push-pin"></i>
                <span>Pin/Unpin</span>
            </div>
            <div class="context-menu-item" data-action="export">
                <i class="ph ph-download-simple"></i>
                <span>Export</span>
            </div>
            <div class="context-menu-item" data-action="share">
                <i class="ph ph-share-network"></i>
                <span>Share</span>
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" data-action="delete">
                <i class="ph ph-trash"></i>
                <span>Delete</span>
            </div>
        </div>

        <!-- Right Toolbar Sidebar -->
        <div id="toolbar-overlay" onclick="UI.toggleToolbar()"></div>
        <div id="right-toolbar">
            <div class="toolbar-header">
                <!-- Empty spacer as requested -->
            </div>

            <div class="toolbar-content">
                <!-- History -->
                <div class="toolbar-section">
                    <div class="section-label">History</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-undo"
                            onmousedown="event.preventDefault(); Logic.formatText('undo')" title="Undo">
                            <i class="ph ph-arrow-u-up-left"></i>
                        </button>
                        <button class="tool-btn" id="btn-redo"
                            onmousedown="event.preventDefault(); Logic.formatText('redo')" title="Redo">
                            <i class="ph ph-arrow-u-up-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Text Style -->
                <div class="toolbar-section">
                    <div class="section-label">Text Style</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-bold"
                            onmousedown="event.preventDefault(); Logic.formatText('bold')" title="Bold">
                            <i class="ph ph-text-b"></i>
                        </button>
                        <button class="tool-btn" id="btn-italic"
                            onmousedown="event.preventDefault(); Logic.formatText('italic')" title="Italic">
                            <i class="ph ph-text-italic"></i>
                        </button>
                        <button class="tool-btn" id="btn-underline"
                            onmousedown="event.preventDefault(); Logic.formatText('underline')" title="Underline">
                            <i class="ph ph-text-underline"></i>
                        </button>
                    </div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-font"
                            onmousedown="event.preventDefault(); Logic.saveSelection(); UI.toggleMenu('font')"
                            title="Font">
                            <i class="ph ph-text-aa"></i>
                        </button>
                        <button class="tool-btn" id="btn-color"
                            onmousedown="event.preventDefault(); Logic.saveSelection(); UI.toggleMenu('color')"
                            title="Color">
                            <i class="ph ph-palette"></i><span id="color-indicator"></span>
                        </button>
                    </div>
                </div>

                <!-- Headings -->
                <div class="toolbar-section">
                    <div class="section-label">Headings</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.formatHeading('H1')"
                            title="Heading 1">
                            <span style="font-weight:800; font-size:14px;">H1</span>
                        </button>
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.formatHeading('H2')"
                            title="Heading 2">
                            <span style="font-weight:700; font-size:13px;">H2</span>
                        </button>
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.formatHeading('H3')"
                            title="Heading 3">
                            <span style="font-weight:600; font-size:12px;">H3</span>
                        </button>
                    </div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-p"
                            onmousedown="event.preventDefault(); Logic.formatHeading('P')" title="Paragraph">
                            <i class="ph ph-paragraph"></i>
                        </button>
                        <button class="tool-btn" id="btn-code"
                            onmousedown="event.preventDefault(); Logic.formatCodeBlock()" title="Code">
                            <i class="ph ph-code"></i>
                        </button>
                    </div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-increase-font"
                            onmousedown="event.preventDefault(); Logic.changeFontSize(2)" title="Increase Font Size">
                            <i class="ph ph-text-aa"></i><span
                                style="font-size: 10px; position:absolute; right:6px; top:6px;">+</span>
                        </button>
                        <button class="tool-btn" id="btn-decrease-font"
                            onmousedown="event.preventDefault(); Logic.changeFontSize(-2)" title="Decrease Font Size">
                            <i class="ph ph-text-aa"></i><span
                                style="font-size: 10px; position:absolute; right:6px; top:6px;">-</span>
                        </button>
                    </div>
                </div>

                <!-- Alignment -->
                <div class="toolbar-section">
                    <div class="section-label">Alignment</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-justifyLeft"
                            onmousedown="event.preventDefault(); Logic.formatText('justifyLeft')" title="Left">
                            <i class="ph ph-text-align-left"></i>
                        </button>
                        <button class="tool-btn" id="btn-justifyCenter"
                            onmousedown="event.preventDefault(); Logic.formatText('justifyCenter')" title="Center">
                            <i class="ph ph-text-align-center"></i>
                        </button>
                        <button class="tool-btn" id="btn-justifyRight"
                            onmousedown="event.preventDefault(); Logic.formatText('justifyRight')" title="Right">
                            <i class="ph ph-text-align-right"></i>
                        </button>
                    </div>
                    <div class="toolbar-row">
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.formatText('outdent')"
                            title="Outdent">
                            <i class="ph ph-text-outdent"></i>
                        </button>
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.formatText('indent')"
                            title="Indent">
                            <i class="ph ph-text-indent"></i>
                        </button>
                    </div>
                </div>

                <!-- Lists & Dividers -->
                <div class="toolbar-section">
                    <div class="section-label">Lists</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-ul"
                            onmousedown="event.preventDefault(); Logic.formatText('insertUnorderedList')"
                            title="Bullets">
                            <i class="ph ph-list-bullets"></i>
                        </button>
                        <button class="tool-btn" id="btn-ol"
                            onmousedown="event.preventDefault(); Logic.formatText('insertOrderedList')" title="Numbers">
                            <i class="ph ph-list-numbers"></i>
                        </button>
                    </div>
                    <div class="toolbar-row">
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.insertDivider('double')"
                            title="Double Line">
                            <i class="ph ph-equals"></i>
                        </button>
                        <button class="tool-btn" onmousedown="event.preventDefault(); Logic.insertDivider('dashed')"
                            title="Dashed Line">
                            <i class="ph ph-minus"></i>
                        </button>
                    </div>
                </div>

                <!-- Tools -->
                <div class="toolbar-section">
                    <div class="section-label">Tools</div>
                    <div class="toolbar-row">
                        <button class="tool-btn" id="btn-find" onmousedown="event.preventDefault(); UI.toggleFind()"
                            title="Find">
                            <i class="ph ph-magnifying-glass"></i>
                        </button>
                        <button class="tool-btn" id="btn-focus"
                            onmousedown="event.preventDefault(); UI.toggleFocusMode()" title="Focus">
                            <i class="ph ph-eye"></i>
                        </button>
                        <button class="tool-btn" id="btn-zen" onmousedown="event.preventDefault(); UI.toggleZen()"
                            title="Zen">
                            <i class="ph ph-frame-corners"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Actions at bottom -->
            <div class="toolbar-footer">
                <button class="action-btn-sidebar pin" id="btn-pin" onclick="Logic.togglePinNote()">
                    <i class="ph ph-push-pin"></i> <span id="pin-text">Pin</span>
                </button>
                <button class="action-btn-sidebar export" id="btn-export" onclick="UI.openModal('export')">
                    <i class="ph ph-download-simple"></i> Export
                </button>
                <button class="action-btn-sidebar share" id="btn-share" onclick="UI.openModal('share')">
                    <i class="ph ph-share-network"></i> Share
                </button>
                <button class="action-btn-sidebar danger" id="desk-delete">
                    <i class="ph ph-trash"></i> Delete
                </button>
            </div>

            <button id="strip-toggle-btn" onclick="UI.toggleToolbar()">
                <i class="ph ph-caret-left"></i>
            </button>
        </div>


        <div id="find-bar">
            <input type="text" class="find-input" id="find-input" placeholder="Search in page..." autocomplete="off">
            <button class="find-btn" id="find-next-btn" onclick="Logic.findNextMatch()"><i
                    class="ph ph-arrow-down"></i></button>
            <button class="find-btn" onclick="UI.toggleFind()"><i class="ph ph-x"></i></button>
        </div>

        <button id="zen-exit-btn" onclick="UI.toggleZen()" title="Exit Zen Mode"><i class="ph ph-x"></i></button>

        <div id="menu-overlay" class="floating-overlay" onclick="UI.closeAllMenus()">

            <div class="floating-menu" id="color-box" onclick="event.stopPropagation()">
                <div class="color-swatch" style="background-color: #ffffff;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#ffffff')"></div>
                <div class="color-swatch" style="background-color: #d1d5db;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#d1d5db')"></div>
                <div class="color-swatch" style="background-color: #9ca3af;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#9ca3af')"></div>
                <div class="color-swatch" style="background-color: #fb923c;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#fb923c')"></div>

                <div class="color-swatch" style="background-color: #f87171;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#f87171')"></div>
                <div class="color-swatch" style="background-color: #4ade80;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#4ade80')"></div>
                <div class="color-swatch" style="background-color: #60a5fa;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#60a5fa')"></div>
                <div class="color-swatch" style="background-color: #c084fc;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#c084fc')"></div>

                <div class="color-swatch" style="background-color: #facc15;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#facc15')"></div>
                <div class="color-swatch" style="background-color: #f472b6;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#f472b6')"></div>
                <div class="color-swatch" style="background-color: #22d3ee;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#22d3ee')"></div>
                <div class="color-swatch" style="background-color: #2dd4bf;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#2dd4bf')"></div>
                <div class="color-swatch" style="background-color: #818cf8;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#818cf8')"></div>
                <div class="color-swatch" style="background-color: #a3e635;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#a3e635')"></div>
                <div class="color-swatch" style="background-color: #fbbf24;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#fbbf24')"></div>
                <div class="color-swatch" style="background-color: #fb7185;" onmousedown="event.preventDefault();"
                    onclick="Logic.setTextColor('#fb7185')"></div>
            </div>

            <div class="floating-menu" id="font-box" onclick="event.stopPropagation()">
                <div class="menu-item" style="font-family:'Fredoka', sans-serif" onclick="Logic.setFont('Fredoka')">
                    Fredoka</div>
                <div class="menu-item" style="font-family:'Playpen Sans', cursive"
                    onclick="Logic.setFont('Playpen Sans')">Playpen</div>
                <div class="menu-item" style="font-family:'Satisfy', cursive" onclick="Logic.setFont('Satisfy')">Satisfy
                </div>
                <div class="menu-item" style="font-family:'Kalam', cursive" onclick="Logic.setFont('Kalam')">Kalam
                </div>
                <div class="menu-item" style="font-family:'Pacifico', cursive" onclick="Logic.setFont('Pacifico')">
                    Pacifico
                </div>
            </div>

        </div>

        <div id="editor-container">
            <div id="editor" contenteditable="true" placeholder="Start typing..." spellcheck="false" data-empty="true">
            </div>
            <div id="status-bar">
                <div class="stat-pill" id="stat-words">0 words</div>
                <div class="stat-pill" id="stat-time">0m read</div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" onclick="UI.closeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div id="modal-icon-container"></div>
            <div class="modal-title" id="m-title">Title</div>
            <div class="modal-desc" id="m-msg" style="display:none;"></div>
            <div id="m-input-view">
                <input type="text" class="modal-input" id="note-name-input" placeholder="Page Name" autocomplete="off"
                    maxlength="50">
            </div>
            <div class="modal-actions">
                <div class="row-btns">
                    <button class="m-btn btn-secondary" id="m-btn-cancel">Cancel</button>
                    <button class="m-btn btn-primary" id="m-btn-confirm">Confirm</button>
                </div>
                <div class="danger-zone" id="m-extra-actions"
                    style="display:none; margin-top:15px; border-top:1px solid #222; padding-top:15px; width:100%; gap:10px;">
                    <button class="m-btn btn-danger" id="m-btn-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Note Modal -->
    <div class="modal-overlay" id="rename-modal-overlay" style="display: none;">
        <div class="modal rename-modal">
            <h3>Rename Note</h3>
            <input type="text" id="rename-note-input" class="rename-input" placeholder="Enter new title" maxlength="50">
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" id="rename-cancel-btn">Cancel</button>
                <button class="modal-btn confirm-btn" id="rename-confirm-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-confirm-overlay" style="display: none;">
        <div class="modal delete-confirm-modal">
            <h3>Delete Note?</h3>
            <p id="delete-note-title"></p>
            <p class="delete-warning">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" id="delete-cancel-btn">Cancel</button>
                <button class="modal-btn delete-btn" id="delete-confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Consolidated JavaScript files -->
    <script src="js/core.js"></script>
    <script src="js/features.js"></script>
    <script src="js/settings.js"></script>
</body>

</html>


css/base.css 
/* ================================
   SOURCE: css/style.css (partial), css/delete-modal.css, css/mobile-mode.css
   PURPOSE: Core reset, layout, base components, and responsive design
   ================================ */

/* --- CORE RESET & THEME VARIABLES --- */
:root {
    /* Dark Theme Default Variables */
    --bg-primary: #050505;
    --bg-secondary: #0a0a0a;
    --bg-tertiary: #111;
    --bg-overlay: rgba(0, 0, 0, 0.7);
    --bg-modal: #0f0f0f;
    --bg-sidebar: rgba(10, 10, 10, 0.9);
    --bg-toolbar: rgba(10, 10, 10, 0.95);
    --bg-chip: #1f2937;
    --bg-chip-hover: #2d3748;
    --bg-chip-active: #374151;
    --bg-code-block: #1e1e1e;
    --bg-input: #1a1a1a;

    --text-primary: #ffffff;
    --text-secondary: #e0e0e0;
    --text-tertiary: #aaa;
    --text-muted: #888;
    --text-disabled: #666;
    --text-code: #d4d4d4;

    --border-primary: #333;
    --border-secondary: #2a2a2a;
    --border-tertiary: #444;
    --border-chip: transparent;
    --border-chip-active: #3b82f6;
    --border-chip-pinned: #fbbf24;

    --accent-primary: #3b82f6;
    --accent-secondary: #22d3ee;
    --accent-danger: #ff4444;
    --accent-warning: #fbbf24;
    --accent-success: #4ade80;

    --button-primary: #fff;
    --button-primary-text: #000;
    --button-secondary: #1a1a1a;
    --button-secondary-text: #ccc;
    --button-danger: #380a0a;
    --button-danger-text: #ff6b6b;

    --shadow-color: rgba(0, 0, 0, 0.6);
    --shadow-modal: 0 40px 80px rgba(0, 0, 0, 0.8);

    --caret-color: #ffffff;
    --selection-bg: rgba(59, 130, 246, 0.3);
}

body[data-theme="light"] {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e8e8e8;
    --bg-overlay: rgba(0, 0, 0, 0.5);
    --bg-modal: #ffffff;
    --bg-sidebar: rgba(255, 255, 255, 0.95);
    --bg-toolbar: rgba(255, 255, 255, 0.95);
    --bg-chip: #e5e5e5;
    --bg-chip-hover: #f0f0f0;
    --bg-chip-active: #ffffff;
    --bg-code-block: #f8f9fa;
    --bg-input: #f8f9fa;

    --text-primary: #000000;
    --text-secondary: #333333;
    --text-tertiary: #555;
    --text-muted: #666;
    --text-disabled: #999;
    --text-code: #333333;

    --border-primary: #ddd;
    --border-secondary: #e5e5e5;
    --border-tertiary: #ccc;
    --border-chip: transparent;
    --border-chip-active: #3b82f6;
    --border-chip-pinned: #fbbf24;

    --accent-primary: #2563eb;
    --accent-secondary: #0891b2;
    --accent-danger: #dc2626;
    --accent-warning: #d97706;
    --accent-success: #059669;

    --button-primary: #000;
    --button-primary-text: #fff;
    --button-secondary: #e5e5e5;
    --button-secondary-text: #333;
    --button-danger: #fee2e2;
    --button-danger-text: #dc2626;

    --shadow-color: rgba(0, 0, 0, 0.1);
    --shadow-modal: 0 20px 40px rgba(0, 0, 0, 0.1);

    --caret-color: #000000;
    --selection-bg: rgba(37, 99, 235, 0.2);
}

/* Apply theme variables */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    scrollbar-width: none;
    -ms-overflow-style: none;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

::-webkit-scrollbar {
    display: none;
}

body,
html {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background-color: var(--bg-primary);
    font-family: "Inter", sans-serif;
    overflow-x: hidden;
    overflow-y: hidden;
    display: flex;
    flex-direction: column;
    color: var(--text-primary);
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* --- AUTH UI --- */
#auth-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.auth-box {
    width: 100%;
    max-width: 380px;
    background: var(--bg-secondary);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-primary);
    padding: 40px;
    border-radius: 24px;
    box-shadow: 0 20px 60px var(--shadow-color);
    text-align: center;
    animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auth-header h2 {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
}

.auth-header p {
    margin: 8px 0 25px 0;
    color: var(--text-muted);
    font-size: 14px;
}

#auth-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.input-group {
    position: relative;
}

.input-group i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-disabled);
    font-size: 18px;
    transition: 0.2s;
}

.input-group input:focus+i,
.input-group:focus-within i {
    color: var(--text-primary);
}

.input-group input {
    width: 100%;
    padding: 14px 14px 14px 44px;
    background: var(--bg-input);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: 0.2s;
}

.input-group input:focus {
    border-color: var(--border-tertiary);
    background: var(--bg-tertiary);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
}

.auth-btn {
    margin-top: 10px;
    width: 100%;
    padding: 14px;
    background: var(--button-primary);
    color: var(--button-primary-text);
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
}

.auth-btn:hover {
    background: var(--button-secondary);
    transform: translateY(-1px);
}

.auth-btn:active {
    transform: scale(0.98);
}

.auth-error {
    color: var(--accent-danger);
    font-size: 13px;
    min-height: 20px;
    text-align: left;
    padding-left: 5px;
    font-weight: 500;
    display: none;
}

.auth-footer {
    margin-top: 25px;
    font-size: 14px;
    color: var(--text-disabled);
}

#auth-switch-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    text-decoration: underline;
    text-decoration-color: var(--border-tertiary);
    transition: 0.2s;
    font-family: "Inter", sans-serif;
}

#auth-switch-btn:hover {
    text-decoration-color: var(--text-primary);
}

/* --- ICONS & BUTTONS --- */
.icon-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

.icon-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

/* --- SIDEBAR (Redesigned) --- */
#sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100%;
    background: var(--bg-sidebar);
    backdrop-filter: blur(25px);
    border-right: 1px solid var(--border-secondary);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
    box-shadow: 10px 0 40px var(--shadow-color);
}

#sidebar.active {
    transform: translateX(0);
}

/* SIDEBAR OVERLAY (New) */
#sidebar-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-overlay);
    z-index: 1900;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(2px);
}

#sidebar-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.sb-header {
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    border-bottom: 1px solid var(--border-secondary);
}

.sb-logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sb-logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
    letter-spacing: 0.5px;
}

.sb-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
    letter-spacing: 0.5px;
}

.sb-content {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
}

.sb-section-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-disabled);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    padding-left: 8px;
}

/* Folders List */
.folders-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 20px;
}

.folder-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 8px;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    background: transparent;
    border: 1px solid transparent;
}

.folder-item i {
    font-size: 16px;
    color: var(--text-disabled);
    flex-shrink: 0;
}

.folder-item:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-primary);
}

.folder-item.active {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-secondary);
}

.folder-item .folder-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.notes-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.note-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    border-radius: 10px;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    background: transparent;
    border: 1px solid transparent;
}

.note-item i {
    font-size: 18px;
    color: var(--text-disabled);
    flex-shrink: 0;
}

.note-item .note-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.note-item:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-primary);
}

.note-item:hover i {
    color: var(--text-muted);
}

.note-item.active {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-secondary);
}

.note-item.active i {
    color: var(--text-primary);
}

.note-item.pinned {
    border-color: rgba(251, 191, 36, 0.3);
}

.note-item.pinned i {
    color: var(--accent-warning);
}

.sb-info {
    text-align: center;
    padding: 30px 20px;
}

.sb-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-disabled);
    margin-bottom: 10px;
    padding-left: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* Sidebar Footer & User Profile */
.sb-footer {
    padding: 20px;
    border-top: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.sb-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 500;
}

.sb-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--border-tertiary);
    color: var(--text-primary);
}

.sb-btn i {
    font-size: 18px;
}

/* Settings Button in Chips Bar */
.settings-btn {
    background: transparent;
    color: var(--text-muted);
    border: 3px solid var(--border-primary);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.settings-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-tertiary);
}

/* --- CHIPS BAR --- */
#chips-bar {
    height: 60px;
    background-color: var(--bg-primary);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 12px;
    border-bottom: 1px solid var(--border-primary);
    flex-shrink: 0;
    z-index: 10;
    width: calc(100% - 60px);
}

.chips-scroll {
    display: flex;
    align-items: center;
    gap: 10px;
    overflow-x: auto;
    overflow-y: hidden;
    flex: 1;
    white-space: nowrap;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
    padding-right: 10px;
    padding-left: 12px;
    padding-bottom: 8px;
}

.chips-scroll::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
}

.chips-scroll::-webkit-scrollbar-thumb {
    background: transparent !important;
}

.chips-scroll::-webkit-scrollbar-track {
    background: transparent !important;
}

/* --- MOBILE RESPONSIVE --- */
@media (max-width: 768px) {
    #sidebar {
        width: 85%;
        max-width: 320px;
    }

    .settings-btn {
        display: none;
        /* Hide settings button on mobile, available in sidebar */
    }
}

.chip {
    background: var(--bg-chip);
    color: var(--text-secondary);
    padding: 10px 18px;
    border-radius: 25px;
    font-size: 14px;
    cursor: pointer;
    border: 2px solid var(--border-chip);
    transition: all 0.25s ease;
    user-select: none;
    min-width: 50px;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
    font-family: 'Fredoka', sans-serif;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    letter-spacing: 0.3px;
    margin-top: 10px;
}

.chip:hover {
    background: var(--bg-chip-hover);
    border-color: var(--border-tertiary);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

.chip:active {
    transform: scale(0.97) translateY(0);
}

/* Active chip (currently being edited) */
.chip.active {
    background: var(--bg-chip-active);
    color: var(--text-primary);
    border-color: var(--border-chip-active);
    font-weight: 600;
    box-shadow: 0 0 0 1px var(--border-chip-active);
}

/* Pinned chip */
.chip.pinned {
    background: var(--bg-chip) !important;
    border-color: var(--border-chip-pinned) !important;
    color: var(--text-primary) !important;
}

/* Pinned + Active chip */
.chip.pinned.active {
    background: var(--bg-chip-active) !important;
    border-color: var(--border-chip-pinned) !important;
    color: var(--text-primary) !important;
    font-weight: 600;
    box-shadow: 0 0 0 2px var(--border-chip-active) !important;
}

/* Unsaved chip - subtle indicator without fading */
.chip.unsaved {
    border-color: var(--accent-danger) !important;
}

.new-btn {
    background: transparent;
    color: var(--text-muted);
    border: 3px solid var(--border-primary);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    font-family: fredoka, "Inter", sans-serif;
    font-weight: 500;
}

.new-btn:hover {
    border-color: var(--border-tertiary);
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

/* --- RIGHT TOOLBAR SIDEBAR --- */
#toolbar-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-overlay);
    z-index: 1800;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#toolbar-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

#right-toolbar {
    position: fixed;
    top: 0;
    right: 0;
    width: 60px;
    height: 100%;
    background: var(--bg-toolbar);
    backdrop-filter: blur(20px);
    border-left: 1px solid var(--border-secondary);
    z-index: 1900;
    display: flex;
    flex-direction: column;
    transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    overflow: hidden;
}

#right-toolbar.expanded {
    width: 260px;
}

.toolbar-header {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border-secondary);
}

.toolbar-header span {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
}

.toolbar-content {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.toolbar-section {
    margin-bottom: 16px;
}

.section-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-disabled);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    padding-left: 4px;
}

.toolbar-row {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
}

.tool-btn {
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 25px;
    color: var(--text-primary);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    position: relative;
}

.tool-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-success);
    color: var(--text-primary);
}

.tool-btn:active {
    transform: scale(0.94);
}

.tool-btn.active {
    background: var(--accent-primary);
    color: var(--text-primary);
    border-color: var(--border-primary);
}

.toolbar-footer {
    padding: 16px;
    border-top: 1px solid var(--border-secondary);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.action-btn-sidebar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Fredoka', sans-serif;
}

.action-btn-sidebar:hover {
    background: var(--bg-secondary);
    border-color: var(--border-tertiary);
    color: var(--text-primary);
}

.action-btn-sidebar i {
    font-size: 16px;
}

.action-btn-sidebar.danger {
    border-color: rgba(255, 77, 77, 0.2);
    color: var(--accent-danger);
}

.action-btn-sidebar.danger:hover {
    background: rgba(255, 77, 77, 0.1);
    border-color: var(--accent-danger);
}

/* Action button color variants */
.action-btn-sidebar.pin {
    border-color: rgba(251, 191, 36, 0.3);
    color: var(--accent-warning);
}

.action-btn-sidebar.pin:hover {
    background: rgba(251, 191, 36, 0.1);
    border-color: var(--accent-warning);
}

.action-btn-sidebar.export {
    border-color: rgba(139, 92, 246, 0.3);
    color: #a78bfa;
}

.action-btn-sidebar.export:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: #8b5cf6;
}

.action-btn-sidebar.share {
    border-color: rgba(34, 211, 238, 0.3);
    color: var(--accent-secondary);
}

.action-btn-sidebar.share:hover {
    background: rgba(34, 211, 238, 0.1);
    border-color: var(--accent-secondary);
}

/* Collapsed State Styling */
#right-toolbar:not(.expanded) .toolbar-header span,
#right-toolbar:not(.expanded) .section-label,
#right-toolbar:not(.expanded) .action-btn-sidebar span {
    display: none;
}

/* Hide specific sections in collapsed mode */
#right-toolbar:not(.expanded) .toolbar-section:nth-of-type(1),
#right-toolbar:not(.expanded) .toolbar-section:nth-of-type(3),
#right-toolbar:not(.expanded) .toolbar-section:nth-of-type(4),
#right-toolbar:not(.expanded) .toolbar-section:nth-of-type(5) {
    display: none;
}

/* Custom Override for Collapsed Visibility */
#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(2) {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(3) {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(3) .toolbar-row:nth-child(1),
#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(3) .toolbar-row:nth-child(2) {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(5) {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(5) .toolbar-row:nth-child(2) {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(5) .toolbar-row:nth-child(1) #btn-ol {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-content>.toolbar-section:nth-of-type(6) {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-footer {
    display: none;
}

#right-toolbar:not(.expanded) .toolbar-row {
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

#right-toolbar:not(.expanded) .toolbar-header {
    display: none;
    padding: 0;
    min-height: 0;
    height: 0;
    overflow: hidden;
}

/* Toolbar Toggle Strip Button */
#strip-toggle-btn {
    width: 100%;
    height: 50px;
    background: transparent;
    border: none;
    border-top: 1px solid var(--border-secondary);
    color: var(--text-disabled);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

#strip-toggle-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

#strip-toggle-btn i {
    font-size: 20px;
    transition: transform 0.3s;
}

#right-toolbar.expanded #strip-toggle-btn i {
    transform: rotate(180deg);
}

/* --- FLOATING MENUS (Color, Font, Heading pickers) --- */
#menu-overlay {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: none;
}

#menu-overlay.active,
.floating-menu.active~#menu-overlay {
    display: block;
}

.floating-menu {
    position: fixed;
    background: var(--bg-secondary);
    backdrop-filter: blur(12px);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 12px;
    z-index: 2100;
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.2s ease;
    box-shadow: 0 8px 32px var(--shadow-color);
}

.floating-menu.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* Color Swatches in floating menu */
.color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--border-primary);
    transition: all 0.15s ease;
    display: inline-block;
    margin: 4px;
}

.color-swatch:hover {
    transform: scale(1.15);
    border-color: var(--border-tertiary);
}

/* Font options in floating menu */
.menu-item {
    padding: 10px 12px;
    border-radius: 6px;
    color: var(--text-tertiary);
    cursor: pointer;
    font-size: 14px;
    text-align: left;
    transition: 0.2s;
}

.menu-item:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

/* --- FIND BAR --- */
#find-bar {
    position: absolute;
    top: 120px;
    right: 20px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 8px;
    display: none;
    align-items: center;
    gap: 8px;
    z-index: 50;
    box-shadow: 0 5px 20px var(--shadow-color);
}

#find-bar.visible {
    display: flex;
    animation: slideIn 0.2s;
}

@keyframes slideIn {
    from {
        transform: translateY(-10px);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.find-input {
    background: var(--bg-input);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    padding: 6px 10px;
    border-radius: 4px;
    font-family: "Inter";
    outline: none;
    width: 200px;
}

.find-btn {
    background: var(--bg-tertiary);
    border: none;
    color: var(--text-tertiary);
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.find-btn:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

/* --- EDITOR --- */
#editor-container {
    flex-grow: 1;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: text;
    width: 100%;
    padding-right: 60px;
}

#editor {
    width: 100%;
    height: 100%;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--editor-font, "Playpen Sans"), cursive;
    font-size: var(--editor-font-size, 18px);
    font-weight: 400;
    line-height: 1.7;
    outline: none;
    overflow-y: auto;
    overflow-x: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    padding: 30px 20px;
    max-width: 1600px;
    margin: 0 auto;
    caret-color: var(--caret-color);
}

#editor ::selection {
    background-color: var(--selection-bg);
}

#editor h1,
#editor h2,
#editor h3,
#editor h4,
#editor h5,
#editor h6,
#editor p,
#editor div,
#editor li {
    margin-top: 0;
    margin-bottom: 8px;
}

#editor h1,
#editor h2,
#editor h3,
#editor h4,
#editor h5,
#editor h6 {
    font-family: "Fredoka", sans-serif;
    color: var(--text-primary);
}

#editor h1 {
    font-size: 32px;
    font-weight: 600;
    margin-top: 15px;
    margin-bottom: 15px;
    line-height: 1.3;
}

#editor h2 {
    font-size: 24px;
    font-weight: 500;
    margin-top: 12px;
    margin-bottom: 10px;
    color: var(--text-secondary);
    line-height: 1.4;
}

#editor ul,
#editor ol {
    margin: 0;
    margin-bottom: 8px;
    padding-left: 40px;
}

#editor pre {
    background: var(--bg-code-block);
    border: 1px solid var(--border-primary);
    border-left: 3px solid var(--accent-success);
    border-radius: 8px;
    padding: 16px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    color: var(--text-code);
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    overflow-wrap: anywhere !important;
    margin: 12px 0;
    line-height: 1.6;
    max-width: 100% !important;
    box-sizing: border-box !important;
}

#editor pre code {
    background: transparent;
    padding: 0;
    font-family: inherit;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    overflow-wrap: anywhere !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
}

#editor pre span,
#editor pre code span {
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    overflow-wrap: anywhere !important;
}

#editor[data-empty="true"]:before {
    content: attr(placeholder);
    color: var(--text-disabled);
    display: block;
    pointer-events: none;
}

/* Stats Bar */
#status-bar {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    pointer-events: none;
    opacity: 0.7;
}

.stat-pill {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    padding: 4px 12px;
    border-radius: 20px;
    color: var(--text-disabled);
    font-size: 11px;
    font-weight: 500;
    backdrop-filter: blur(2px);
}

/* Zen Exit */
#zen-exit-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-overlay);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: 0.2s;
    font-size: 20px;
}

#zen-exit-btn:hover {
    background: var(--bg-tertiary);
    transform: scale(1.1);
}

/* --- MODALS --- */
#modal-overlay {
    display: none;
    position: fixed;
    font-family: fredoka;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-overlay);
    backdrop-filter: blur(10px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.25s ease;
}

#modal-overlay.visible {
    opacity: 1;
}

.modal-box {
    background: var(--bg-modal);
    border: 1px solid var(--border-primary);
    padding: 35px;
    border-radius: 20px;
    width: 90%;
    max-width: 380px;
    text-align: center;
    box-shadow: var(--shadow-modal);
    transform: scale(0.92);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#modal-overlay.visible .modal-box {
    transform: scale(1);
}

.modal-title {
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.5px;
}

.modal-desc {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 25px;
    line-height: 1.5;
}

.modal-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    border-radius: 12px;
    font-family: fredoka, "Inter", sans-serif;
    font-size: 16px;
    outline: none;
    margin-bottom: 25px;
    text-align: left;
    transition: 0.2s;
}

.modal-input:focus {
    border-color: var(--border-tertiary);
    background: var(--bg-tertiary);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
}

.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.row-btns {
    display: flex;
    gap: 12px;
    justify-content: center;
    width: 100%;
}

.m-btn {
    flex: 1;
    padding: 14px 0;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-family: "Inter", sans-serif;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--button-primary);
    color: var(--button-primary-text);
}

.btn-primary:hover {
    background: var(--button-secondary);
    transform: translateY(-1px);
}

.btn-secondary {
    background: transparent;
    color: var(--button-secondary-text);
    border: 1px solid var(--border-primary);
}

.btn-secondary:hover {
    color: var(--text-primary);
    border-color: var(--border-tertiary);
    background: var(--bg-tertiary);
}

.btn-danger {
    background: var(--button-danger);
    color: var(--button-danger-text);
    border: 1px solid rgba(255, 77, 77, 0.3);
}

.btn-danger:hover {
    background: rgba(255, 77, 77, 0.2);
    color: var(--accent-danger);
}

.confirm-icon-wrapper {
    width: 60px;
    height: 60px;
    background: rgba(255, 77, 77, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px auto;
    color: var(--accent-danger);
    font-size: 28px;
    border: 1px solid rgba(255, 77, 77, 0.3);
}

/* Settings Modal */
.settings-modal {
    max-width: 500px;
    padding: 0;
}

.settings-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-primary);
}

.settings-modal .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-content {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 30px;
}

.settings-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-secondary);
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-info {
    flex: 1;
}

.setting-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.setting-description {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
}

.theme-toggle {
    display: flex;
    gap: 8px;
    background: var(--bg-tertiary);
    padding: 4px;
    border-radius: 12px;
}

.theme-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: var(--text-tertiary);
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.theme-option:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.theme-option.active {
    background: var(--accent-primary);
    color: var(--text-primary);
}

.setting-select {
    padding: 8px 12px;
    border: 1px solid var(--border-primary);
    background: var(--bg-input);
    color: var(--text-primary);
    border-radius: 8px;
    font-size: 14px;
    min-width: 150px;
    outline: none;
    cursor: pointer;
}

.setting-select:focus {
    border-color: var(--accent-primary);
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--border-primary);
    transition: .4s;
    border-radius: 28px;
}

.toggle-switch .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background: var(--text-tertiary);
    transition: .4s;
    border-radius: 50%;
}

.toggle-switch input:checked+.slider {
    background: var(--accent-success);
}

.toggle-switch input:checked+.slider:before {
    transform: translateX(22px);
    background: var(--text-primary);
}

.modal-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border-primary);
    display: flex;
    justify-content: flex-end;
}

/* --- DELETE & RENAME MODALS --- */
#delete-confirm-overlay,
#rename-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    backdrop-filter: blur(4px);
}

.modal.delete-confirm-modal,
.modal.rename-modal {
    background: var(--bg-modal);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    max-width: 400px;
    width: 90%;
    padding: 24px;
    box-shadow: 0 8px 32px var(--shadow-color);
    animation: modalFadeIn 0.2s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

.delete-confirm-modal h3 {
    margin: 0 0 16px 0;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
}

.delete-confirm-modal p {
    margin: 0 0 12px 0;
    color: var(--text-secondary);
    font-size: 14px;
}

#delete-note-title {
    font-weight: 500;
    color: var(--text-primary);
    background: var(--bg-tertiary);
    padding: 10px 14px;
    border-radius: 6px;
    margin-bottom: 16px;
    word-break: break-word;
}

.delete-warning {
    color: var(--accent-danger);
    font-size: 13px;
    margin-bottom: 20px !important;
}

.rename-modal h3 {
    margin: 0 0 16px 0;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'Fredoka', sans-serif;
}

.rename-input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-input);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: 'Fredoka', sans-serif;
    margin-bottom: 20px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.rename-input:focus {
    border-color: var(--accent-primary);
}

.modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    font-family: 'Fredoka', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
}

.cancel-btn {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.cancel-btn:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.delete-btn {
    background: var(--accent-danger);
    color: var(--text-primary);
}

.delete-btn:hover {
    background: #ff2222;
}

.confirm-btn {
    background: var(--accent-primary);
    color: var(--text-primary);
}

.confirm-btn:hover {
    background: #2563eb;
}

/* --- ZEN MODE --- */
body.zen-active #toolbar,
body.zen-active #chips-bar {
    display: none !important;
}

body.zen-active #zen-exit-btn {
    display: flex;
}

body.zen-active #editor-container {
    padding-top: 20px;
}

/* Custom font classes */
.kalam {
    font-family: 'Kalam', cursive;
}

.pacifico {
    font-family: 'Pacifico', cursive;
}

.satisfy {
    font-family: 'Satisfy', cursive;
}

/* --- FOCUS MODE STYLES (NEW) --- */
.focus-mode-active>* {
    opacity: 0.15;
    transition: opacity 0.4s ease;
    filter: blur(0.5px);
}

.focus-mode-active>.focused-block {
    opacity: 1;
    filter: none;
}

/* --- CODE BLOCKS (NEW) --- */
pre.code-block {
    background-color: var(--bg-code-block);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 12px;
    font-family: monospace;
    color: var(--text-code);
    white-space: pre-wrap;
    margin: 10px 0;
    position: relative;
    tab-size: 4;
}

pre.code-block code {
    font-family: monospace;
}

/* Syntax Highlighting Colors */
.code-keyword {
    color: #569cd6;
    font-weight: bold;
}

.code-string {
    color: #ce9178;
}

.code-comment {
    color: #6a9955;
    font-style: italic;
}

.code-number {
    color: #b5cea8;
}

.code-function {
    color: #dcdcaa;
}

/* --- SHARE MODAL STYLES (NEW) --- */
.share-container {
    text-align: left;
    margin-top: 10px;
}

.share-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-tertiary);
    padding: 15px 10px;
    border-radius: 12px;
    border: 1px solid var(--border-primary);
    margin-bottom: 20px;
}

.share-label {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 15px;
}

.share-sub {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 4px;
}

/* Toggle Switch */
.toggle-switch .slider {
    background: var(--border-primary);
}

.toggle-switch .slider:before {
    background: var(--text-tertiary);
}

input:checked+.slider {
    background: var(--accent-secondary);
}

input:checked+.slider:before {
    background: var(--text-primary);
}

/* Link Box */
.link-box {
    margin-top: 12px;
    display: none;
    gap: 8px;
    opacity: 0.5;
    pointer-events: none;
    transition: opacity 0.3s;
}

.link-box.active {
    opacity: 1;
    pointer-events: auto;
}

.link-input {
    flex: 1;
    background: var(--bg-input);
    border: 1px solid var(--border-primary);
    color: var(--text-muted);
    padding: 10px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    outline: none;
}

#btn-copy {
    width: auto;
    padding: 0 15px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

#btn-copy:hover {
    background: var(--bg-secondary);
}

/* Export Modal Styles */
.export-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 15px;
}

.export-option-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    width: 100%;
}

.export-option-btn i {
    font-size: 32px;
    color: var(--text-muted);
}

.export-option-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--border-tertiary);
    transform: translateY(-2px);
}

.export-option-btn:hover i {
    color: var(--text-primary);
}

.export-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.export-desc {
    font-size: 12px;
    color: var(--text-muted);
}

/* Custom Dividers */
.custom-divider {
    width: 100%;
    margin: 15px 0;
    border: 0;
    display: block;
}

.divider-double {
    border-top: 3px double var(--border-tertiary);
}

.divider-dashed {
    border-top: 2px dashed var(--border-tertiary);
}

/* Chip Context Menu */
.chip-context-menu {
    position: fixed;
    background: var(--bg-modal);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 4px;
    min-width: 160px;
    box-shadow: 0 4px 12px var(--shadow-color);
    z-index: 9999;
    animation: contextMenuFadeIn 0.15s ease;
}

@keyframes contextMenuFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    color: var(--text-secondary);
    font-size: 13px;
    font-family: 'Fredoka', sans-serif;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
}

.context-menu-item:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.context-menu-item i {
    font-size: 16px;
}

.context-menu-item.danger {
    color: var(--accent-danger);
}

.context-menu-item.danger:hover {
    background: rgba(255, 107, 107, 0.1);
    color: #ff4444;
}

.context-menu-divider {
    height: 1px;
    background: var(--border-primary);
    margin: 4px 0;
}

/* Pin Filter Button */
.pin-filter-btn {
    background: transparent;
    color: var(--text-muted);
    border: 3px solid var(--border-primary);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pin-filter-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-tertiary);
}

.pin-filter-btn.active {
    background: var(--accent-warning);
    color: #1f2937;
    border-color: var(--accent-warning);
}

/* Pinned-only view styles */
body.pinned-view .chip {
    background: var(--bg-chip);
    border: 2px solid var(--border-chip-pinned);
    color: var(--text-primary);
    transition: all 0.15s ease;
}

body.pinned-view .chip:hover {
    border-color: #facc15;
    background: var(--bg-chip-hover);
}

body.pinned-view .chip.active {
    border: 2px solid var(--border-chip-pinned);
    box-shadow: 0 0 0 2px var(--border-chip-active);
    background: var(--bg-chip-active);
}

body.pinned-view .chip .dot {
    display: none;
}

/* Empty state for pinned view */
body.pinned-view .chip-empty {
    background: transparent;
    border: 2px dashed var(--border-chip-pinned);
    color: var(--text-muted);
}

body.pinned-view .chip-empty:hover {
    background: transparent;
    border-color: var(--border-chip-pinned);
}

/* --- MOBILE RESPONSIVE --- */
@media (max-width: 768px) {
    #sidebar {
        display: none !important;
    }

    #right-toolbar,
    #toolbar-overlay {
        display: none !important;
    }

    #status-bar {
        display: none !important;
    }

    #menu-btn {
        display: none !important;
    }

    #new-note-btn,
    .new-btn {
        display: none !important;
    }

    #pin-filter-btn,
    .pin-filter-btn {
        display: none !important;
    }

    .chips-container {
        width: 100% !important;
        left: 0 !important;
    }

    #chips-bar {
        padding-right: 0 !important;
        width: 100% !important;
    }

    .icon-btn {
        display: none;
    }

    #editor-container {
        margin-left: 0 !important;
        width: 100% !important;
        padding-right: 0;
    }

    #editor {
        padding: 20px 16px !important;
        font-size: 14px !important;
    }

    #editor h1 {
        font-size: 24px !important;
    }

    #editor h2 {
        font-size: 20px !important;
    }

    #editor h3,
    #editor h4,
    #editor h5,
    #editor h6 {
        font-size: 16px !important;
    }

    .chip {
        font-size: 12px !important;
        padding: 6px 12px !important;
    }
}

/* Mobile-specific class added via JS */
body.mobile-mode #editor {
    cursor: default !important;
}

body.mobile-mode #editor:focus {
    outline: none;
}

/* Mobile Print Menu */
.mobile-print-menu {
    position: fixed;
    background: var(--bg-modal);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 4px;
    min-width: 150px;
    box-shadow: 0 4px 12px var(--shadow-color);
    z-index: 99999;
    transform: translate(-50%, -100%) translateY(-10px);
}

.mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    color: var(--text-secondary);
    font-size: 14px;
    font-family: 'Fredoka', sans-serif;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
}

.mobile-menu-item:active {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.mobile-menu-item i {
    font-size: 18px;
}

/* --- PRINT STYLES FOR MAIN APP PDF EXPORT --- */
@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html,
    body {
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        background-color: var(--bg-primary) !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    #auth-overlay,
    #sidebar,
    #sidebar-overlay,
    #chips-bar,
    #right-toolbar,
    #toolbar-overlay,
    #find-bar,
    #zen-exit-btn,
    #menu-overlay,
    #modal-overlay,
    #status-bar,
    .header-actions,
    .print-controls {
        display: none !important;
    }

    #app-wrapper {
        display: block !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    #editor-container {
        display: block !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        padding: 0 !important;
        margin: 0 !important;
        position: static !important;
        transform: none !important;
    }

    #editor {
        display: block !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        overflow-y: visible !important;
        padding: 15mm !important;
        margin: 0 !important;
        position: static !important;
        transform: none !important;
        background-color: var(--bg-primary) !important;
        color: var(--text-code) !important;
    }

    #editor pre,
    .code-block {
        background: var(--bg-code-block) !important;
        border: 1px solid var(--border-primary) !important;
        page-break-inside: avoid;
        overflow: visible !important;
        white-space: pre-wrap !important;
    }

    #editor h1,
    #editor h2,
    #editor h3,
    #editor p,
    #editor blockquote {
        page-break-inside: avoid;
    }

    #editor h1,
    #editor h2 {
        page-break-after: avoid;
    }

    #editor hr {
        border-color: var(--border-tertiary) !important;
        page-break-after: auto;
    }
}


css/theme.css 
/* ================================
   SOURCE: css/style.css (partial), css/pin-filter.css, css/chip-context-menu.css
   PURPOSE: Theme variables, dark theme, editor colors, text formatting, and component themes
   ================================ */

/* --- ZEN MODE --- */
body.zen-active #toolbar,
body.zen-active #chips-bar {
    display: none !important;
}

body.zen-active #zen-exit-btn {
    display: flex;
}

body.zen-active #editor-container {
    padding-top: 20px;
}

/* Custom font classes */
.kalam {
    font-family: 'Kalam', cursive;
}

.pacifico {
    font-family: 'Pacifico', cursive;
}

.satisfy {
    font-family: 'Satisfy', cursive;
}

/* --- FOCUS MODE STYLES (NEW) --- */
/* When active, dim everything in editor */
.focus-mode-active>* {
    opacity: 0.15;
    /* Dimmed state */
    transition: opacity 0.4s ease;
    filter: blur(0.5px);
    /* Subtle blur for better focus on active */
}

/* The active block stays bright */
.focus-mode-active>.focused-block {
    opacity: 1;
    filter: none;
}

/* Focus Mode Styling */
#editor.focus-mode-active>*:not(.focused-block) {
    opacity: 0.3;
    transition: opacity 0.3s ease;
}

#editor.focus-mode-active>.focused-block {
    opacity: 1;
}

/* Highlight style for search results */
.search-highlight {
    background-color: #fbc531;
    color: #000 !important;
    border-radius: 2px;
    box-shadow: 0 0 4px #fbc531;
}

.search-highlight.current {
    background-color: #ff9f43;
    box-shadow: 0 0 6px #ff9f43;
}

/* --- CODE BLOCKS (NEW) --- */
pre.code-block {
    background-color: #1e1e1e;
    /* Darker than editor */
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    font-family: monospace;
    color: #d4d4d4;
    white-space: pre-wrap;
    margin: 10px 0;
    position: relative;
    tab-size: 4;
}

pre.code-block code {
    font-family: monospace;
}

/* Syntax Highlighting Colors - VS Code Style */
.code-keyword {
    color: #569cd6;
    font-weight: bold;
}

/* Blue (const, let, function) */
.code-string {
    color: #ce9178;
}

/* Orange ("string") */
.code-comment {
    color: #6a9955;
    font-style: italic;
}

/* Green (// comment) */
.code-number {
    color: #b5cea8;
}

/* Light Green (123) */
.code-function {
    color: #dcdcaa;
}

/* Yellow (funcName) */

/* --- SHARE MODAL STYLES (NEW) --- */
.share-container {
    text-align: left;
    margin-top: 10px;
}

.share-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1a1a1a;
    padding: 15px 10px;
    border-radius: 12px;
    border: 1px solid #333;
    margin-bottom: 20px;
}

.share-label {
    color: #fff;
    font-weight: 600;
    font-size: 15px;
}

.share-sub {
    color: #888;
    font-size: 12px;
    margin-top: 2px;
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    cursor: pointer;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    inset: 0;
    background-color: #333;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: #888;
    transition: .4s;
    border-radius: 50%;
}

input:checked+.slider {
    background-color: #22d3ee;
    /* Cyan brand color */
}

input:checked+.slider:before {
    transform: translateX(24px);
    background-color: #fff;
}

/* Link Box */
.link-box {
    display: flex;
    gap: 8px;
    opacity: 0.5;
    pointer-events: none;
    transition: opacity 0.3s;
}

.link-box.active {
    opacity: 1;
    pointer-events: auto;
}

.link-input {
    flex: 1;
    background: #000;
    border: 1px solid #333;
    color: #888;
    padding: 10px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    outline: none;
}

#btn-copy {
    width: auto;
    padding: 0 15px;
    background: #222;
    color: #fff;
    border: 1px solid #333;
    border-radius: 8px;
    cursor: pointer;
}

#btn-copy:hover {
    background: #333;
}

/* Export Modal Styles */
.export-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 15px;
}

.export-option-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px;
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    width: 100%;
}

.export-option-btn i {
    font-size: 32px;
    color: #888;
}

.export-option-btn:hover {
    background: #1a1a1a;
    border-color: #555;
    transform: translateY(-2px);
}

.export-option-btn:hover i {
    color: #fff;
}

.export-title {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
}

.export-desc {
    font-size: 12px;
    color: #888;
}

/* Custom Dividers */
.custom-divider {
    width: 100%;
    margin: 15px 0;
    border: 0;
    display: block;
}

.divider-double {
    border-top: 3px double #666;
}

.divider-dashed {
    border-top: 2px dashed #666;
}

@media print {
    .custom-divider {
        opacity: 1 !important;
        visibility: visible !important;
        margin: 10px 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .divider-double {
        border-top: 3px double #000 !important;
    }

    .divider-dashed {
        border-top: 2px dashed #000 !important;
    }
}

/* ================================
   SOURCE: css/pin-filter.css
   PURPOSE: Pin filter button and pinned view theme styles
   ================================ */

/* Pin Filter Button */
.pin-filter-btn {
    background: transparent;
    color: #888;
    border: 3px solid #e3dcdc;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pin-filter-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    border-color: #ddd;
}

.pin-filter-btn.active {
    background: #fbbf24;
    color: #1f2937;
    border-color: #fbbf24;
}

/* Pinned-only view styles */
body.pinned-view .chip {
    background: #1f2937;
    border: 2px solid #fbbf24;
    color: #ffffff;
    transition: all 0.15s ease;
}

body.pinned-view .chip:hover {
    border-color: #facc15;
    background: #2d3748;
}

body.pinned-view .chip.active {
    border: 2px solid #fbbf24;
    box-shadow: 0 0 0 2px #3b82f6;
    background: #374151;
}

body.pinned-view .chip .dot {
    display: none;
}

/* Empty state for pinned view */
body.pinned-view .chip-empty {
    background: transparent;
    border: 2px dashed #fbbf24;
    color: #888;
}

body.pinned-view .chip-empty:hover {
    background: transparent;
    border-color: #fbbf24;
}

/* Pinned chips styling in NORMAL view */
.chip.pinned {
    background: #1f2937;
    border: 2px solid #fbbf24;
    color: #ffffff;
}

.chip.pinned:hover {
    border-color: #facc15;
    background: #2d3748;
}

.chip.pinned.active {
    border: 2px solid #fbbf24;
    box-shadow: 0 0 0 2px #3b82f6;
    background: #374151;
}

/* ================================
   SOURCE: css/chip-context-menu.css
   PURPOSE: Chip context menu theme styles
   ================================ */

/* Chip Context Menu */
.chip-context-menu {
    position: fixed;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 4px;
    min-width: 160px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    z-index: 9999;
    animation: contextMenuFadeIn 0.15s ease;
}

@keyframes contextMenuFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    color: #ccc;
    font-size: 13px;
    font-family: 'Fredoka', sans-serif;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
}

.context-menu-item:hover {
    background: #2a2a2a;
    color: #fff;
}

.context-menu-item i {
    font-size: 16px;
}

.context-menu-item.danger {
    color: #ff6b6b;
}

.context-menu-item.danger:hover {
    background: rgba(255, 107, 107, 0.1);
    color: #ff4444;
}

.context-menu-divider {
    height: 1px;
    background: #333;
    margin: 4px 0;
}

js/core.js 
/* ================================
   SOURCE: js/auth.js
   PURPOSE: Authentication and user management
   ================================ */

// Supabase Auth Implementation
const Auth = {
    currentUser: null,
    supabase: null,

    init: async function () {
        // Get Supabase client from Store
        if (Store && Store.supabase) {
            this.supabase = Store.supabase;
        } else {
            console.error("Supabase client not initialized");
            return false;
        }

        // 1. Listen for Auth State Changes
        this.supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                console.log("Auth Event:", event);
            }
        });

        // 2. Check for existing session
        const { data: { session }, error } = await this.supabase.auth.getSession();

        if (error) {
            console.error("Session error:", error);
            return false;
        }

        if (session) {
            // Check admin status before allowing full login
            const statusAllowed = await this.checkUserStatus(session.user.id);
            if (!statusAllowed) {
                await this.supabase.auth.signOut();
                return false;
            }

            this.currentUser = {
                id: session.user.id,
                email: session.user.email
            };

            return true; // Logged in
        }

        return false; // Not logged in
    },

    checkUserStatus: async function (userId) {
        try {
            const { data, error } = await this.supabase
                .from('users')
                .select('status')
                .eq('id', userId)
                .single();

            if (error) {
                console.error("Status check failed or pending:", error);
                return false;
            }

            if (data) {
                if (data.status === 'banned') {
                    alert("Account Banned");
                    return false;
                }
                if (data.status === 'deleted') {
                    alert("Login Rejected By Admin");
                    return false;
                }
                // 'user_added' and 'confirmed' are valid
                return true;
            }
            return false;
        } catch (e) {
            console.error("Auth status error", e);
            return false;
        }
    },

    login: async function (email, password) {
        try {
            const { data, error } = await this.supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                return { success: false, message: error.message };
            }

            // Check status immediately after login
            const statusAllowed = await this.checkUserStatus(data.user.id);
            if (!statusAllowed) {
                await this.supabase.auth.signOut();
                return { success: false, message: "Account access restricted." };
            }

            this.currentUser = {
                id: data.user.id,
                email: data.user.email
            };

            return { success: true };
        } catch (err) {
            return { success: false, message: "Login failed: " + err.message };
        }
    },

    register: async function (email, password) {
        try {
            // Get the current URL to ensure redirect comes back here
            const redirectUrl = window.location.href.split('#')[0].split('?')[0];

            const { data, error } = await this.supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    emailRedirectTo: redirectUrl // Forces return to this page
                }
            });

            if (error) {
                return { success: false, message: error.message };
            }

            // If Confirm Email is ON in Supabase:
            if (data.user && !data.session) {
                return { success: false, message: "Verification link sent! Check your email." };
            }

            // If Confirm Email is OFF (Auto login):
            if (data.session) {
                this.currentUser = {
                    id: data.user.id,
                    email: data.user.email
                };
                return { success: true };
            }

            return { success: false, message: "Unexpected signup state." };

        } catch (err) {
            return { success: false, message: "Signup failed: " + err.message };
        }
    },

    logout: async function () {
        // CHANGED: Using new 'logout' mode instead of generic 'delete-confirm'
        UI.openModal('logout', null, null, async () => {
            try {
                await this.supabase.auth.signOut();
                this.currentUser = null;
                window.location.reload();
            } catch (err) {
                console.error("Logout error:", err);
                window.location.reload(); // Force reload anyway
            }
        });
    },

    getCurrentUserId: function () {
        return this.currentUser ? this.currentUser.id : null;
    },

    showAuth: function () {
        if (AuthUI && AuthUI.els) {
            AuthUI.els.overlay.style.display = 'flex';
            AuthUI.els.app.style.display = 'none';
        }
    }
};

// UI Handler for Auth Forms
const AuthUI = {
    isLoginMode: true,
    els: {},

    init: function () {
        this.els = {
            overlay: document.getElementById('auth-overlay'),
            app: document.getElementById('app-wrapper'),
            loader: document.querySelector('.auth-loader'),
            authBox: document.querySelector('.auth-box'),
            title: document.getElementById('auth-title'),
            subtitle: document.getElementById('auth-subtitle'),
            btn: document.getElementById('auth-submit-btn'),
            switchText: document.getElementById('auth-switch-text'),
            switchBtn: document.getElementById('auth-switch-btn'),
            email: document.getElementById('auth-email'),
            pass: document.getElementById('auth-pass'),
            error: document.getElementById('auth-error'),
            form: document.getElementById('auth-form')
        };

        this.els.form.onsubmit = (e) => {
            e.preventDefault();
            this.handleSubmit();
        };
    },

    toggleMode: function () {
        this.isLoginMode = !this.isLoginMode;
        this.els.error.style.display = 'none';
        this.els.email.value = '';
        this.els.pass.value = '';

        if (this.isLoginMode) {
            this.els.title.innerText = "Welcome Back";
            this.els.subtitle.innerText = "Login to access your private notes";
            this.els.btn.innerText = "Login";
            this.els.switchText.innerText = "Don't have an account?";
            this.els.switchBtn.innerText = "Sign Up";
        } else {
            this.els.title.innerText = "Create Account";
            this.els.subtitle.innerText = "Start your distraction-free journey";
            this.els.btn.innerText = "Sign Up";
            this.els.switchText.innerText = "Already have an account?";
            this.els.switchBtn.innerText = "Login";
        }
    },

    handleSubmit: async function () {
        const email = this.els.email.value.trim();
        const pass = this.els.pass.value;

        if (!email) {
            this.showError("Email is required");
            return;
        }

        if (pass.length < 6) {
            this.showError("Password must be at least 6 characters");
            return;
        }

        this.els.btn.innerText = "Processing...";
        this.els.btn.disabled = true;
        this.els.error.style.display = 'none';

        let result;

        if (this.isLoginMode) {
            result = await Auth.login(email, pass);
        } else {
            result = await Auth.register(email, pass);
        }

        if (result.success) {
            // Normal Login Success
            this.showApp();
        } else {
            // Error or "Check Email" message
            this.showError(result.message);

            // Check if it was a "Check Email" message to change UI state
            if (result.message.includes("Check your email")) {
                this.els.title.innerText = "Verify Email";
                this.els.subtitle.innerText = "We sent a link to " + email;
                this.els.btn.style.display = "none"; // Hide button
            } else {
                this.els.btn.innerText = this.isLoginMode ? "Login" : "Sign Up";
                this.els.btn.disabled = false;
            }
        }
    },

    showError: function (msg) {
        this.els.error.innerText = msg;
        this.els.error.style.display = 'block';
    },

    showApp: function () {
        this.els.overlay.style.display = 'none';
        this.els.app.style.display = 'flex';
        // Initialize the main app now that we have a user
        initApp();

        // Show a gentle toast/alert if we just loaded
        if (window.location.hash && window.location.hash.includes('access_token')) {
            window.history.replaceState(null, null, window.location.pathname);
            console.log("Email verified & Logged in.");
        }
    },

    showLogin: function () {
        this.els.overlay.style.display = 'flex';
        this.els.app.style.display = 'none';
        if (this.els.loader) this.els.loader.style.display = 'none';
        if (this.els.authBox) this.els.authBox.style.display = 'block';
    },

    showAuth: function () {
        this.showLogin();
    }
};

// Check Login on Load
document.addEventListener('DOMContentLoaded', async () => {
    AuthUI.init();
    const isLoggedIn = await Auth.init();
    if (isLoggedIn) {
        AuthUI.showApp();
    } else {
        AuthUI.showLogin();
    }
});

/* ================================
   SOURCE: js/store.js
   PURPOSE: Data storage, Supabase integration, and note management
   ================================ */

// Initialize Supabase client immediately (before Auth needs it)
const _supabaseClient = (function () {
    const SUPABASE_URL = 'https://qtmtkivntdiswetuqlar.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0bXRraXZudGRpc3dldHVxbGFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTg0ODIsImV4cCI6MjA4NDA3NDQ4Mn0.2UokvTemzginYSYrDhCFjbtmBih_m0kV8kr1i2EYmzc';

    try {
        if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_KEY) {
            return supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    } catch (err) {
        console.error("Supabase client initialization error:", err);
    }
    return null;
})();

const Store = {
    supabase: _supabaseClient,
    notes: [],
    activeId: null,
    unsavedId: null,
    timer: null,

    init: async function () {
        // Ensure User is logged in
        if (!Auth.getCurrentUserId()) return;

        // Load data from Supabase
        if (this.supabase) {
            this.loadPinOrder();
            await this.loadNotesFromSupabase();

            // If no notes exist, create a default one
            if (this.notes.length === 0) {
                await this.createNote("Untitled");
            } else {
                // Set first note as active
                this.activeId = this.notes[0].id;
            }
        }
    },

    // =============================================
    // NOTES
    // =============================================

    loadNotesFromSupabase: async function () {
        try {
            const { data, error } = await this.supabase
                .from('notes')
                .select('*')
                .order('updated_at', { ascending: false });

            if (error) throw error;
            this.notes = data || [];
        } catch (e) {
            console.error("Load notes error:", e);
            this.notes = [];
        }
    },

    getActiveNote: function () {
        return this.notes.find(x => x.id === this.activeId);
    },

    createNote: async function (title) {
        console.log('createNote called with title:', title);

        // Save current note first
        if (this.activeId) this.saveImmediate();
        this.cancelSave();

        // Check user ID
        const userId = Auth.getCurrentUserId();
        console.log('User ID:', userId);

        if (!userId) {
            console.error('No user ID found - user may not be logged in');
            alert('Error: Not logged in. Please refresh the page.');
            return null;
        }

        if (!this.supabase) {
            console.error('Supabase client not initialized');
            alert('Error: Database connection failed. Please refresh the page.');
            return null;
        }

        try {
            console.log('Inserting note into Supabase...');
            const { data, error } = await this.supabase
                .from('notes')
                .insert([{
                    user_id: userId,
                    title: title || 'Untitled',
                    content: '',
                    is_public: false
                }])
                .select()
                .single();

            if (error) {
                console.error('Supabase insert error:', error);
                alert('Error creating note: ' + error.message);
                throw error;
            }

            console.log('Note created successfully:', data);

            // Add to local state (prepend to top)
            this.notes.unshift(data);
            this.activeId = data.id;

            return data.id;
        } catch (e) {
            console.error("Create note error:", e);
            return null;
        }
    },

    deleteNote: async function (id) {
        try {
            const { error } = await this.supabase
                .from('notes')
                .delete()
                .eq('id', id);

            if (error) throw error;

            // Remove from local state
            this.notes = this.notes.filter(n => n.id !== id);

            // Select another note
            if (this.activeId === id) {
                if (this.notes.length > 0) {
                    this.activeId = this.notes[0].id;
                } else {
                    // Create a new note if empty to avoid broken UI
                    await this.createNote("Untitled");
                }
            }
        } catch (e) {
            console.error("Delete note error:", e);
        }
    },

    updateTitle: async function (id, title) {
        try {
            const { error } = await this.supabase
                .from('notes')
                .update({ title: title, updated_at: new Date() })
                .eq('id', id);

            if (error) throw error;

            // Update local state
            const note = this.notes.find(n => n.id === id);
            if (note) {
                note.title = title;
                note.updated_at = new Date().toISOString();
            }

            // Re-sort notes locally
            this.notes.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
        } catch (e) {
            console.error("Update title error:", e);
        }
    },

    // --- PIN LOGIC ---
    pinnedOrder: [], // Cache for pin order

    loadPinOrder: function () {
        try {
            const stored = localStorage.getItem('focuspad_pin_order');
            if (stored) this.pinnedOrder = JSON.parse(stored);
        } catch (e) { console.error('Error loading pin order', e); }
    },

    savePinOrder: function () {
        localStorage.setItem('focuspad_pin_order', JSON.stringify(this.pinnedOrder));
    },

    getPinnedIndex: function (id) {
        const idx = this.pinnedOrder.indexOf(id);
        return idx === -1 ? 999999 : idx; // If not found, put at end
    },

    togglePinStatus: async function (id, status) {
        console.log('togglePinStatus called with:', id, status);

        try {
            const { data, error } = await this.supabase
                .from('notes')
                .update({ is_pinned: status, updated_at: new Date() })
                .eq('id', id)
                .select();

            if (error) {
                console.error('Supabase error toggling pin:', error);
                alert('Error: ' + error.message);
                return false;
            }

            const n = this.notes.find(x => x.id === id);
            if (n) {
                n.is_pinned = status;
                n.updated_at = new Date().toISOString();
                console.log('Local state updated:', n.title, 'is_pinned:', n.is_pinned);

                // Update Order
                if (status) {
                    // Pinning: Add to end if not present
                    if (!this.pinnedOrder.includes(id)) {
                        this.pinnedOrder.push(id);
                        this.savePinOrder();
                    }
                } else {
                    // Unpinning: Remove
                    this.pinnedOrder = this.pinnedOrder.filter(x => x !== id);
                    this.savePinOrder();
                }
            }

            return true;
        } catch (e) {
            console.error("Exception toggling pin status:", e);
            alert('Error toggling pin: ' + e.message);
            return false;
        }
    },

    // Get all notes - NO sorting, maintain original order
    getFilteredNotes: function () {
        // Return notes as-is - no sorting to prevent reordering
        return this.notes;
    },

    // --- PUBLIC SHARE LOGIC ---
    togglePublicStatus: async function (id, status) {
        const { error } = await this.supabase
            .from('notes')
            .update({ is_public: status })
            .eq('id', id);

        if (!error) {
            const n = this.notes.find(x => x.id === id);
            if (n) n.is_public = status;
            return true;
        }
        console.error("Error toggling public status:", error);
        return false;
    },

    save: function () {
        // Check if auto-save is enabled
        const settings = Settings.getSettings ? Settings.getSettings() : { autoSave: true };
        if (settings.autoSave === false) return;

        this.cancelSave();
        // Mark as unsaved visually
        if (this.activeId) {
            this.unsavedId = this.activeId;
            if (typeof UI !== 'undefined' && UI.setUnsaved) UI.setUnsaved(this.activeId, true);
        }
        this.saveTimeout = setTimeout(() => this.saveImmediate(), 500); // Auto-save after 500ms
    },

    cancelSave: function () {
        if (this.saveTimeout) {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = null;
        }
    },

    saveImmediate: async function () {
        const editor = document.getElementById('editor');
        const note = this.notes.find(x => x.id === this.activeId);

        // Clear unsaved state immediately for UI responsiveness
        this.unsavedId = null;
        if (typeof UI !== 'undefined' && UI.setUnsaved) UI.setUnsaved(this.activeId, false);

        if (note && editor) {
            let cleanContent = editor.innerHTML;

            // Feature Preservation: Strip search highlights before saving
            cleanContent = cleanContent.replace(/<mark class="search-highlight[^>]*>([^<]*)<\/mark>/gi, '$1');

            // CLEANUP: Remove Focus Mode classes to prevent saving 'dimmed' state to DB
            cleanContent = cleanContent.replace(/class="focused-block"/g, '');

            // Optimistic Update (no re-sorting to prevent position change)
            note.content = cleanContent;
            note.updated_at = new Date().toISOString();

            try {
                const { error } = await this.supabase
                    .from('notes')
                    .update({
                        content: cleanContent,
                        updated_at: new Date()
                    })
                    .eq('id', this.activeId);

                if (error) throw error;
            } catch (e) {
                console.error("Save error:", e);
            }
        }
    },

    // =============================================
    // LEGACY METHODS (Preserved for compatibility)
    // =============================================

    getIdKey: function () {
        return 'focuspad_active_id';
    },

    getStorageKey: function () {
        return 'focuspad_notes_' + Auth.getCurrentUserId();
    },

    saveToStorageOnly: function () {
        // No-op in Supabase version, but kept if UI calls it
    }
};

/* ================================
   SOURCE: js/main.js
   PURPOSE: App initialization, bootstrapping, and core event listeners
   ================================ */

async function initApp() {
    UI.cacheElements();
    await Auth.init();
    await Store.init();
    UI.renderChips();
    UI.loadNoteContent();

    document.execCommand('defaultParagraphSeparator', false, 'p');

    setupListeners();
}

function setupListeners() {
    // Context menu clicks
    const contextMenu = document.getElementById('chip-context-menu');
    if (contextMenu) {
        contextMenu.addEventListener('click', (e) => {
            const item = e.target.closest('.context-menu-item');
            if (item) {
                const action = item.dataset.action;
                const noteId = contextMenu.dataset.noteId;
                if (action && noteId) {
                    UI.handleChipContextAction(action, noteId);
                }
            }
        });
    }

    // Editor Events
    UI.els.editor.addEventListener('mouseup', () => {
        Logic.checkToolbarState();
        Logic.saveSelection();
        Logic.highlightActiveBlock();
    });
    UI.els.editor.addEventListener('keyup', (e) => {
        Logic.checkToolbarState();
        Logic.saveSelection();
        Logic.highlightActiveBlock();
    });

    // --- KEYBOARD MANAGER ---
    document.addEventListener('keydown', (e) => {
        // 1. CTRL + F Override
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
            e.preventDefault();
            if (!UI.isModalOpen()) {
                if (!UI.els.findBar.classList.contains('visible')) {
                    UI.toggleFind();
                } else {
                    UI.els.findInput.focus();
                    UI.els.findInput.select();
                }
            }
            return;
        }

        // 2. ESC Priority Stack (LIFO)
        if (e.key === 'Escape') {
            // Priority 1: Floating Menus
            if (document.querySelector('.floating-menu.active')) {
                UI.closeAllMenus();
                e.preventDefault();
                return;
            }
            // Priority 2: Main Modal (Overlay is on top of Search)
            if (UI.els.modalOverlay.classList.contains('visible')) {
                UI.closeModal();
                e.preventDefault();
                return;
            }
            // Priority 3: Search
            if (UI.els.findBar.classList.contains('visible')) {
                UI.toggleFind();
                e.preventDefault();
                return;
            }
            // Priority 4: Zen Mode
            if (document.body.classList.contains('zen-active')) {
                UI.toggleZen();
                e.preventDefault();
                return;
            }
            // Priority 5: Mobile Sidebar (Close if Open)
            if (UI.els.sidebar.classList.contains('active')) {
                UI.toggleSidebar();
                e.preventDefault();
                return;
            }
            // Priority 6: Settings Modal
            const settingsModal = document.getElementById('settings-modal-overlay');
            if (settingsModal && settingsModal.style.display === 'flex') {
                UI.closeSettingsModal();
                e.preventDefault();
                return;
            }
        }
    });

    // Editor Shortcuts
    UI.els.editor.addEventListener('keydown', (e) => {
        // Handle paste event for better formatting
        if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
            setTimeout(() => {
                Logic.cleanPastedContent();
            }, 0);
        }

        // Handle Shortcut Fallback on Enter (MUST run first)
        if (e.key === 'Enter') {
            Logic.handleEnterShortcuts(e);
            // If shortcut was detected, event is prevented and we return early
            if (e.defaultPrevented) return;

            // Check if we're in a heading - if so, create clean paragraph after
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                let node = sel.anchorNode;
                if (node.nodeType === 3) node = node.parentNode;

                // Find if we're in a heading
                let current = node;
                while (current && current.id !== 'editor') {
                    if (current.tagName && ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(current.tagName)) {
                        // We're in a heading - need to ensure next line is paragraph
                        e.preventDefault();

                        // Create new paragraph
                        const p = document.createElement('p');
                        p.innerHTML = '<br>';
                        current.after(p);

                        // Move cursor to new paragraph
                        const range = document.createRange();
                        range.setStart(p, 0);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);

                        return;
                    }
                    current = current.parentNode;
                }
            }
        }

        // Handle Markdown Triggers (Headings on Enter)
        Logic.handleMarkdownTriggers(e);

        // Handle List Logic (Enter & Backspace)
        if (e.key === 'Enter' || e.key === 'Backspace') {
            Logic.handleListInput(e);
        }

        // Update focus mode on Enter/Arrow keys
        if (e.key === 'Enter' || e.key.startsWith('Arrow')) {
            setTimeout(() => Logic.highlightActiveBlock(), 10);
        }

        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.execCommand('insertParagraph', false, null);
            document.execCommand('formatBlock', false, 'p');
            document.execCommand('removeFormat', false, null);
            document.execCommand('unlink', false, null);
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('hiliteColor', false, 'transparent');
            document.execCommand('foreColor', false, '#e0e0e0');
            document.execCommand('styleWithCSS', false, false);
            document.execCommand('fontName', false, 'Fredoka');
            document.execCommand('fontSize', false, '3');
        }
    });

    // Click below content
    UI.els.container.addEventListener('click', (e) => {
        if (e.target === UI.els.container || e.target === UI.els.editor) {
            UI.els.editor.focus();
            const lastChild = UI.els.editor.lastElementChild;
            if (lastChild && (lastChild.tagName === 'PRE' || lastChild.tagName === 'DIV' || lastChild.style.backgroundColor)) {
                const p = document.createElement('p');
                p.innerHTML = '<br>';
                UI.els.editor.appendChild(p);
                const range = document.createRange();
                range.selectNodeContents(p);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                Logic.saveSelection();
            }
        }
    });

    // Auto Save
    UI.els.editor.addEventListener('input', (e) => {
        Logic.handleInput(e);
        UI.checkPlaceholder();
        UI.updateStats();
        Store.save();
        Logic.saveSelection();
    });

    // Search
    UI.els.findInput.addEventListener('input', (e) => {
        Logic.performSearch(e.target.value);
    });

    UI.els.findInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            Logic.findNextMatch();
        }
    });

    // Bindings
    document.getElementById('new-note-btn').onclick = () => UI.openModal('create');
    document.getElementById('desk-delete').onclick = () => UI.openModal('delete-confirm', Store.activeId);
    document.getElementById('m-btn-delete').onclick = () => UI.openModal('delete-confirm', UI.targetId);

    UI.els.btnConfirm.onclick = () => UI.handleModalConfirm();
    UI.els.btnCancel.onclick = () => UI.closeModal();

    // Modal Enter Key Support
    if (UI.els.mInput) {
        UI.els.mInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') UI.handleModalConfirm();
        });
    }

    // PWA Install Logic
    const installBtn = document.getElementById('btn-install-sidebar');

    if (installBtn) {
        installBtn.onclick = () => Logic.installPWA();
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        Logic.deferredPrompt = e;
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
    });

    window.addEventListener('appinstalled', () => {
        if (installBtn) {
            installBtn.style.display = 'none';
        }
        Logic.deferredPrompt = null;
    });
}

/* ================================
   SOURCE: Inline script from index.html
   PURPOSE: Service worker registration
   ================================ */

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW Registered'))
            .catch(err => console.log('SW Failed', err));
    });
}

js/features.js 
/* ================================
   SOURCE: js/ui.js
   PURPOSE: User interface rendering, modals, and UI interactions
   NOTE: This must be defined FIRST because other files depend on it
   ================================ */

// js/ui.js - MOVED TO TOP for proper initialization
const UI = {
    els: {},

    cacheElements: function () {
        this.els.appWrapper = document.getElementById('app-wrapper');
        this.els.authOverlay = document.getElementById('auth-overlay');
        this.els.editor = document.getElementById('editor');
        this.els.container = document.getElementById('editor-container');
        this.els.chipsBar = document.getElementById('chips-scroll-container');
        this.els.menuOverlay = document.getElementById('menu-overlay');

        // Menus
        this.els.fontBox = document.getElementById('font-box');
        this.els.colorBox = document.getElementById('color-box');
        this.els.headingBox = document.getElementById('heading-box');

        // Sidebar
        this.els.sidebar = document.getElementById('sidebar');
        this.els.sidebarOverlay = document.getElementById('sidebar-overlay');

        // Right Toolbar
        this.els.rightToolbar = document.getElementById('right-toolbar');
        this.els.toolbarOverlay = document.getElementById('toolbar-overlay');

        // Search/Find
        this.els.findBar = document.getElementById('find-bar');
        this.els.findInput = document.getElementById('find-input');

        // Stats
        this.els.statWords = document.getElementById('stat-words');
        this.els.statTime = document.getElementById('stat-time');

        // Modal
        this.els.modalOverlay = document.getElementById('modal-overlay');
        this.els.mTitle = document.getElementById('m-title');
        this.els.mMsg = document.getElementById('m-msg');
        this.els.mInput = document.getElementById('note-name-input');
        this.els.mInputView = document.getElementById('m-input-view');
        this.els.btnConfirm = document.getElementById('m-btn-confirm');
        this.els.btnCancel = document.getElementById('m-btn-cancel');
        this.els.btnDelete = document.getElementById('m-btn-delete');
        this.els.extraActions = document.getElementById('m-extra-actions');
        this.els.modalIcon = document.getElementById('modal-icon-container');

        // User Info & Buttons
        this.els.userEmailDisplay = document.getElementById('user-email-display');
        this.els.btnShare = document.getElementById('btn-share');
    },

    isModalOpen: function () {
        return this.els.modalOverlay.classList.contains('visible') ||
            (document.getElementById('settings-modal-overlay') &&
                document.getElementById('settings-modal-overlay').style.display === 'flex');
    },

    toggleSidebar: function () {
        this.els.sidebar.classList.toggle('active');
        // Toggle the background overlay too
        if (this.els.sidebarOverlay) {
            this.els.sidebarOverlay.classList.toggle('active');
        }

        // Populate email if we have it and haven't already
        if (Auth.currentUser && this.els.userEmailDisplay) {
            this.els.userEmailDisplay.innerText = Auth.currentUser.email;
        }
    },

    toggleToolbar: function () {
        if (this.els.rightToolbar) {
            this.els.rightToolbar.classList.toggle('expanded');
        }
        if (this.els.toolbarOverlay) {
            this.els.toolbarOverlay.classList.toggle('active');
        }
    },

    togglePinFilter: function () {
        document.body.classList.toggle('pinned-view');
        const btn = document.getElementById('pin-filter-btn');
        if (btn) {
            btn.classList.toggle('active');
        }
        this.renderChips();
    },

    // --- Date Helpers ---
    isToday: function (d) {
        const today = new Date();
        return d.getDate() === today.getDate() &&
            d.getMonth() === today.getMonth() &&
            d.getFullYear() === today.getFullYear();
    },

    isYesterday: function (d) {
        const y = new Date();
        y.setDate(y.getDate() - 1);
        return d.getDate() === y.getDate() &&
            d.getMonth() === y.getMonth() &&
            d.getFullYear() === y.getFullYear();
    },

    formatDateGroup: function (d) {
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    },

    // Render only top 8 notes modified TODAY (or pinned notes if in pinned view)
    renderChips: function () {
        this.els.chipsBar.innerHTML = "";

        const notes = Store.getFilteredNotes();

        // Check if we're in pinned-view mode
        const isPinnedView = document.body.classList.contains('pinned-view');

        let finalNotes;

        if (isPinnedView) {
            // Pinned View: Show only pinned notes from last 4-5 days
            const daysAgo = new Date();
            daysAgo.setDate(daysAgo.getDate() - 5);

            const recentPinned = notes.filter(n => {
                if (!n.is_pinned) return false;
                const d = new Date(n.updated_at || n.created_at || Date.now());
                return d >= daysAgo;
            });

            // Sort by pin order
            recentPinned.sort((a, b) => {
                return Store.getPinnedIndex(a.id) - Store.getPinnedIndex(b.id);
            });

            finalNotes = recentPinned.slice(0, 8);

            // Handle empty state
            if (finalNotes.length === 0) {
                const emptyChip = document.createElement('div');
                emptyChip.className = 'chip chip-empty';
                emptyChip.textContent = 'No pinned notes';
                emptyChip.style.opacity = '0.5';
                emptyChip.style.cursor = 'default';
                this.els.chipsBar.appendChild(emptyChip);
                return;
            }
        } else {
            // Normal View: Only notes from TODAY
            const recentNotes = notes.filter(n => {
                const d = new Date(n.updated_at || n.created_at || Date.now());
                return this.isToday(d);
            });

            // Split into Pinned and Unpinned
            let unpinned = recentNotes.filter(n => !n.is_pinned);
            let pinned = recentNotes.filter(n => n.is_pinned);

            // Sort Pinned by pin order
            pinned.sort((a, b) => {
                return Store.getPinnedIndex(a.id) - Store.getPinnedIndex(b.id);
            });

            // Combine: Unpinned FIRST, then Pinned at END
            finalNotes = [...unpinned, ...pinned].slice(0, 8);
        }

        finalNotes.forEach(note => {
            const chip = document.createElement('div');
            chip.className = "chip";
            chip.id = `chip-${note.id}`;
            if (note.id == Store.activeId) chip.classList.add("active");

            // Add 'pinned' class for visual indication
            if (note.is_pinned) {
                chip.classList.add('pinned');
            }

            // Check unsaved
            if (Store.unsavedId === note.id) {
                chip.classList.add('unsaved');
            }

            // Truncate title to 2 words + '..'
            let displayTitle = note.title || "Untitled";
            const words = displayTitle.split(' ');
            if (words.length > 2) {
                displayTitle = words.slice(0, 2).join(' ') + '..';
            }

            const textNode = document.createTextNode(displayTitle);
            chip.appendChild(textNode);

            chip.onclick = () => Logic.switchNote(note.id);

            // Right-click context menu
            chip.oncontextmenu = (e) => {
                e.preventDefault();
                UI.showChipContextMenu(e, note.id);
            };

            this.els.chipsBar.appendChild(chip);
        });

        // Update pin button state
        if (typeof Logic !== 'undefined' && Logic.updatePinButton) {
            Logic.updatePinButton();
        }

        // Also render notes list in sidebar
        this.renderNotesList();
    },

    showChipContextMenu: function (e, noteId) {
        const menu = document.getElementById('chip-context-menu');
        if (!menu) return;

        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.dataset.noteId = noteId;

        setTimeout(() => {
            document.addEventListener('click', () => this.hideChipContextMenu(), { once: true });
        }, 10);
    },

    hideChipContextMenu: function () {
        const menu = document.getElementById('chip-context-menu');
        if (menu) {
            menu.style.display = 'none';
            delete menu.dataset.noteId;
        }
    },

    handleChipContextAction: function (action, noteId) {
        this.hideChipContextMenu();

        const note = Store.notes.find(n => n.id === noteId);
        if (!note) {
            console.error('Note not found:', noteId);
            return;
        }

        // Set as active note before any action (important for modal operations)
        const wasActive = Store.activeId === noteId;
        if (!wasActive) {
            Store.activeId = noteId;
            this.loadNoteContent();
        }

        switch (action) {
            case 'rename':
                this.showRenameModal(noteId, note.title);
                break;

            case 'pin':
                const newStatus = !note.is_pinned;
                Store.togglePinStatus(noteId, newStatus).then(() => {
                    this.renderChips();
                    this.renderNotesList();
                });
                break;

            case 'export':
                // Trigger existing export modal
                this.openModal('export');
                break;

            case 'share':
                // Trigger existing share modal
                this.openModal('share');
                break;

            case 'delete':
                this.showDeleteConfirm(noteId, note.title);
                break;
        }
    },

    showDeleteConfirm: function (noteId, noteTitle) {
        const overlay = document.getElementById('delete-confirm-overlay');
        const titleEl = document.getElementById('delete-note-title');
        const confirmBtn = document.getElementById('delete-confirm-btn');
        const cancelBtn = document.getElementById('delete-cancel-btn');

        if (!overlay || !titleEl || !confirmBtn || !cancelBtn) return;

        titleEl.textContent = noteTitle || 'Untitled';
        overlay.style.display = 'flex';

        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Cancel handler
        newCancelBtn.onclick = () => {
            overlay.style.display = 'none';
        };

        // Confirm handler
        newConfirmBtn.onclick = () => {
            overlay.style.display = 'none';
            Store.deleteNote(noteId).then(() => {
                this.renderChips();
                this.renderNotesList();
                this.loadNoteContent();
            });
        };

        // Click outside to close
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        };
    },

    showRenameModal: function (noteId, currentTitle) {
        const overlay = document.getElementById('rename-modal-overlay');
        const input = document.getElementById('rename-note-input');
        const confirmBtn = document.getElementById('rename-confirm-btn');
        const cancelBtn = document.getElementById('rename-cancel-btn');

        if (!overlay || !input || !confirmBtn || !cancelBtn) return;

        input.value = currentTitle || '';
        overlay.style.display = 'flex';

        // Focus input and select text
        setTimeout(() => {
            input.focus();
            input.select();
        }, 100);

        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Cancel handler
        newCancelBtn.onclick = () => {
            overlay.style.display = 'none';
        };

        // Confirm handler
        newConfirmBtn.onclick = () => {
            const newTitle = input.value.trim();
            if (newTitle && newTitle !== currentTitle) {
                overlay.style.display = 'none';
                Store.updateTitle(noteId, newTitle).then(() => {
                    this.renderChips();
                    this.renderNotesList();
                });
            } else {
                overlay.style.display = 'none';
            }
        };

        // Enter key to confirm
        input.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                newConfirmBtn.click();
            } else if (e.key === 'Escape') {
                overlay.style.display = 'none';
            }
        };

        // Click outside to close
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        };
    },

    setUnsaved: function (id, isUnsaved) {
        const chip = document.getElementById(`chip-${id}`);
        if (chip) {
            if (isUnsaved) chip.classList.add('unsaved');
            else chip.classList.remove('unsaved');
        }
    },

    // Render all notes in sidebar with Date Grouping
    renderNotesList: function () {
        const notesList = document.getElementById('notes-list');
        if (!notesList) return;

        notesList.innerHTML = "";
        const notes = Store.getFilteredNotes();

        let currentGroup = null;

        notes.forEach(note => {
            // Determine Group
            const date = new Date(note.updated_at || note.created_at || Date.now());
            let group = "";

            if (this.isToday(date)) group = "Today";
            else if (this.isYesterday(date)) group = "Yesterday";
            else group = this.formatDateGroup(date);

            // Render Header if group changes
            if (group !== currentGroup) {
                const header = document.createElement('div');
                header.className = 'sidebar-date-header';
                header.innerText = group;
                notesList.appendChild(header);
                currentGroup = group;
            }

            // Render Note Item
            const item = document.createElement('div');
            item.className = "note-item";
            if (note.id == Store.activeId) item.classList.add("active");
            if (note.is_pinned) item.classList.add("pinned");

            item.innerHTML = `
                <i class="ph ${note.is_pinned ? 'ph-push-pin' : 'ph-note'}"></i>
                <span class="note-title">${note.title}</span>
            `;

            item.onclick = () => {
                Logic.switchNote(note.id);
                // Close sidebar on mobile after selecting
                if (window.innerWidth < 769) {
                    UI.toggleSidebar();
                }
            };

            notesList.appendChild(item);
        });
    },

    loadNoteContent: function () {
        const n = Store.getActiveNote();
        Logic.clearSearch();
        this.els.editor.innerHTML = n ? n.content : "";
        this.updateStats();
        this.checkPlaceholder();

        this.els.editor.classList.remove('focus-mode-active');
        const focusBtn = document.getElementById('btn-focus');
        if (focusBtn) focusBtn.classList.remove('active');
    },

    updateStats: function () {
        const txt = this.els.editor.innerText.trim();
        const wc = txt ? txt.split(/\s+/).length : 0;
        this.els.statWords.innerText = `${wc} words`;
        this.els.statTime.innerText = `${Math.ceil(wc / 200)}m read`;
    },

    checkPlaceholder: function () {
        const content = this.els.editor.innerText.replace(/\u200B/g, '').trim();
        const hasImg = this.els.editor.querySelector('img') !== null;
        const hasSvg = this.els.editor.querySelector('svg') !== null;
        const isEmpty = content.length === 0 && !hasImg && !hasSvg;
        this.els.editor.setAttribute('data-empty', isEmpty);
        if (isEmpty && this.els.editor.innerHTML !== "") {
            this.els.editor.innerHTML = "";
        }
    },

    toggleZen: function () {
        document.body.classList.toggle('zen-active');
    },

    toggleFocusMode: function () {
        this.els.editor.classList.toggle('focus-mode-active');
        const btn = document.getElementById('btn-focus');
        if (btn) btn.classList.toggle('active');

        if (this.els.editor.classList.contains('focus-mode-active')) {
            Logic.highlightActiveBlock();
        }
    },

    toggleFind: function () {
        const isVisible = this.els.findBar.classList.contains('visible');
        if (isVisible) {
            this.els.findBar.classList.remove('visible');
            Logic.clearSearch();
            this.els.editor.focus();
        } else {
            this.els.findBar.classList.add('visible');
            this.els.findInput.value = '';
            this.els.findInput.focus();
        }
    },

    toggleMenu: function (type) {
        let target, btnId;
        if (type === 'font') { target = this.els.fontBox; btnId = 'btn-font'; }
        else if (type === 'color') { target = this.els.colorBox; btnId = 'btn-color'; }
        else if (type === 'heading') { target = this.els.headingBox; btnId = 'btn-heading'; }

        const isVisible = target.classList.contains('active');
        this.closeAllMenus();

        if (!isVisible) {
            this.els.menuOverlay.style.display = 'block';

            const btn = document.getElementById(btnId);
            if (btn) {
                const rect = btn.getBoundingClientRect();
                let left = rect.left;

                if (left + 220 > window.innerWidth) {
                    left = window.innerWidth - 230;
                }

                target.style.top = (rect.bottom + 12) + 'px';
                target.style.left = left + 'px';
            }

            void target.offsetWidth;
            target.classList.add('active');
        }
    },

    closeAllMenus: function () {
        [this.els.fontBox, this.els.colorBox, this.els.headingBox].forEach(el => el && el.classList.remove('active'));
        setTimeout(() => {
            if (!document.querySelector('.floating-menu.active')) this.els.menuOverlay.style.display = 'none';
        }, 200);
    },

    // Modal Logic
    currentModalMode: null,
    targetId: null,
    modalCallback: null,

    openModal: function (mode, titleOrId, msgOrLabel = null, callback = null) {
        this.currentModalMode = mode;
        this.modalCallback = callback;

        // Reset Defaults
        this.els.modalOverlay.style.display = 'flex';
        requestAnimationFrame(() => this.els.modalOverlay.classList.add('visible'));

        // Hide all specifics initially
        this.els.mInputView.style.display = 'none';
        this.els.extraActions.style.display = 'none';
        this.els.mMsg.style.display = 'none';
        this.els.modalIcon.style.display = 'none';
        this.els.modalIcon.innerHTML = '';

        this.els.btnConfirm.innerText = "OK";
        this.els.btnConfirm.className = "m-btn btn-primary";
        this.els.btnCancel.style.display = "block";

        if (mode === 'create') {
            this.targetId = null;
            this.els.mTitle.innerText = "New Page";
            this.els.mInputView.style.display = 'block';
            this.els.mInput.placeholder = "Page Name";
            this.els.mInput.value = "";
            setTimeout(() => this.els.mInput.focus(), 100);
            this.els.btnConfirm.innerText = "Create";

        } else if (mode === 'input') {
            this.els.mTitle.innerText = titleOrId;
            this.els.mInputView.style.display = 'block';
            this.els.mInput.placeholder = msgOrLabel || "Enter value...";
            this.els.mInput.value = "";
            setTimeout(() => this.els.mInput.focus(), 100);
            this.els.btnConfirm.innerText = "Confirm";

        } else if (mode === 'edit-note') {
            this.targetId = titleOrId || Store.activeId;
            const n = Store.notes.find(x => x.id == this.targetId);
            this.els.mTitle.innerText = "Edit Note";
            this.els.mInputView.style.display = 'block';
            this.els.mInput.value = n ? n.title : "";
            this.els.mInput.placeholder = "Note Name";
            setTimeout(() => this.els.mInput.focus(), 100);

            this.els.btnConfirm.innerText = "Save";
            if (window.innerWidth < 769) this.els.extraActions.style.display = 'flex';

        } else if (mode === 'edit') {
            this.targetId = titleOrId || Store.activeId;
            const n = Store.notes.find(x => x.id == this.targetId);
            this.els.mTitle.innerText = "Edit Page";
            this.els.mInputView.style.display = 'block';
            this.els.mInput.value = n ? n.title : "";
            this.els.btnConfirm.innerText = "Save Name";
            if (window.innerWidth < 769) this.els.extraActions.style.display = 'flex';

        } else if (mode === 'delete-confirm') {
            this.targetId = titleOrId || Store.activeId;
            this.els.modalIcon.style.display = 'flex';
            this.els.modalIcon.innerHTML = '<div class="confirm-icon-wrapper"><i class="ph ph-warning-octagon"></i></div>';

            this.els.mTitle.innerText = "Delete Page?";
            this.els.mMsg.style.display = 'block';
            this.els.mMsg.innerText = typeof msgOrLabel === 'string' ? msgOrLabel : "Are you sure? This cannot be undone.";

            this.els.btnConfirm.innerText = "Delete";
            this.els.btnConfirm.className = "m-btn btn-danger";

        } else if (mode === 'logout') {
            this.els.mTitle.innerText = "Log Out";
            this.els.mMsg.style.display = 'block';
            this.els.mMsg.innerText = "Are you sure you want to log out?";
            this.els.btnConfirm.innerText = "Log Out";
            this.els.btnConfirm.className = "m-btn btn-primary";
            this.els.modalIcon.style.display = 'flex';
            this.els.modalIcon.innerHTML = '<div class="confirm-icon-wrapper" style="background: #222; border-color: #333; color: #fff;"><i class="ph ph-sign-out"></i></div>';

        } else if (mode === 'share') {
            // --- SHARE MODAL ---
            this.targetId = Store.activeId;
            const note = Store.getActiveNote();
            const isPublic = note ? note.is_public : false;
            const link = `https://apandey-focuspad.vercel.app/share.html?id=${this.targetId}`;

            this.els.mTitle.innerText = "Share Note";
            this.els.mMsg.style.display = 'block';

            this.els.mMsg.innerHTML = `
                <div class="share-container">
                    <div class="share-row">
                        <div>
                            <div class="share-label">Public Access</div>
                            <div class="share-sub">Anyone with the link can view</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="share-toggle" ${isPublic ? 'checked' : ''} onchange="Logic.toggleShare(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="link-box ${isPublic ? 'active' : ''}" id="share-link-box">
                        <input type="text" class="link-input" value="${link}" readonly>
                        <button id="btn-copy" onclick="Logic.copyShareLink()">Copy</button>
                    </div>
                </div>
            `;

            this.els.btnConfirm.innerText = "Done";
            this.els.btnCancel.style.display = "none";

        } else if (mode === 'export') {
            this.targetId = Store.activeId;
            const note = Store.getActiveNote();

            this.els.mTitle.innerText = "Export Note";
            this.els.mMsg.style.display = 'block';
            this.els.mMsg.innerHTML = `
                <div class="export-options">
                    <button class="export-option-btn" onclick="Logic.exportNote('pdf')">
                        <i class="ph ph-file-pdf"></i>
                        <div>
                            <div class="export-title">PDF Document</div>
                            <div class="export-desc">Print-ready format with styling</div>
                        </div>
                    </button>
                    <button class="export-option-btn" onclick="Logic.exportNote('markdown')">
                        <i class="ph ph-file-text"></i>
                        <div>
                            <div class="export-title">Markdown</div>
                            <div class="export-desc">Plain text with formatting</div>
                        </div>
                    </button>
                    <button class="export-option-btn" onclick="Logic.exportNote('text')">
                        <i class="ph ph-file"></i>
                        <div>
                            <div class="export-title">Plain Text</div>
                            <div class="export-desc">No formatting, just text</div>
                        </div>
                    </button>
                </div>
            `;

            this.els.btnConfirm.innerText = "Close";
            this.els.btnCancel.style.display = "none";
        }
    },

    closeModal: function () {
        this.els.modalOverlay.classList.remove('visible');
        setTimeout(() => { this.els.modalOverlay.style.display = 'none'; this.els.editor.focus(); }, 250);
        this.modalCallback = null;
    },

    handleModalConfirm: async function () {
        const val = this.els.mInput.value.trim();
        let success = true;

        if (this.currentModalMode === 'input' && this.modalCallback) {
            const result = await this.modalCallback(val);
            if (result === false) success = false;
        } else if (this.currentModalMode === 'create') {
            console.log('handleModalConfirm: create mode, calling Store.createNote with:', val || "Untitled");
            const newId = await Store.createNote(val || "Untitled");
            console.log('handleModalConfirm: createNote returned:', newId);
            if (newId) {
                console.log('handleModalConfirm: rendering chips and loading content');
                this.renderChips();
                this.loadNoteContent();
            } else {
                console.error('handleModalConfirm: createNote failed, no new ID returned');
                success = false;
            }
        } else if (this.currentModalMode === 'edit') {
            await Store.updateTitle(this.targetId, val || "Untitled");
            this.renderChips();
        } else if (this.currentModalMode === 'edit-note') {
            await Store.updateTitle(this.targetId, val || "Untitled");
            this.renderChips();
            this.loadNoteContent();
        } else if (this.currentModalMode === 'delete-confirm') {
            if (this.modalCallback) {
                await this.modalCallback();
            } else {
                await Store.deleteNote(this.targetId);
                this.renderChips();
                this.loadNoteContent();
            }
        } else if (this.currentModalMode === 'logout') {
            if (this.modalCallback) await this.modalCallback();
        } else if (this.currentModalMode === 'share') {
            success = true; // Just close
        } else if (this.currentModalMode === 'export') {
            success = true; // Just close
        }

        if (success) {
            this.closeModal();
        }
    }
};

/* ================================
   SOURCE: js/pin-filter.js
   PURPOSE: Pin filter toggle functionality
   NOTE: Must come AFTER UI is defined
   ================================ */

// Pin Filter Toggle - Attach to existing UI object
UI.togglePinFilter = function () {
    document.body.classList.toggle('pinned-view');
    const btn = document.getElementById('pin-filter-btn');
    if (btn) {
        btn.classList.toggle('active');
    }
    this.renderChips();
};

/* ================================
   SOURCE: js/chip-context-menu.js
   PURPOSE: Chip context menu handling
   NOTE: Must come AFTER UI is defined
   ================================ */

// Chip Context Menu - Attach to existing UI object
UI.showChipContextMenu = function (e, noteId) {
    const menu = document.getElementById('chip-context-menu');
    if (!menu) return;

    menu.style.display = 'block';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.dataset.noteId = noteId;

    setTimeout(() => {
        document.addEventListener('click', () => UI.hideChipContextMenu(), { once: true });
    }, 10);
};

UI.hideChipContextMenu = function () {
    const menu = document.getElementById('chip-context-menu');
    if (menu) {
        menu.style.display = 'none';
        delete menu.dataset.noteId;
    }
};

UI.handleChipContextAction = function (action, noteId) {
    UI.hideChipContextMenu();

    const note = Store.notes.find(n => n.id === noteId);
    if (!note) return;

    switch (action) {
        case 'rename':
            const newTitle = prompt('Enter new title:', note.title);
            if (newTitle && newTitle.trim()) {
                Store.updateTitle(noteId, newTitle.trim());
                UI.renderChips();
            }
            break;
        case 'pin':
            const newStatus = !note.is_pinned;
            Store.togglePinStatus(noteId, newStatus);
            UI.renderChips();
            break;
        case 'export':
            if (typeof Logic !== 'undefined' && Logic.exportNoteToPDF) {
                Logic.exportNoteToPDF(noteId);
            }
            break;
        case 'share':
            if (typeof Logic !== 'undefined' && Logic.shareNote) {
                Logic.shareNote(noteId);
            }
            break;
        case 'delete':
            if (confirm(`Delete "${note.title}"?`)) {
                Store.deleteNote(noteId);
            }
            break;
    }
};

// Initialize context menu clicks (will run when DOM is ready)
document.addEventListener('DOMContentLoaded', () => {
    const contextMenu = document.getElementById('chip-context-menu');
    if (contextMenu) {
        contextMenu.addEventListener('click', (e) => {
            const item = e.target.closest('.context-menu-item');
            if (item) {
                const action = item.dataset.action;
                const noteId = contextMenu.dataset.noteId;
                if (action && noteId) {
                    UI.handleChipContextAction(action, noteId);
                }
            }
        });
    }
});

/* ================================
   SOURCE: js/mobile-mode.js
   PURPOSE: Mobile device detection and read-only mode
   ================================ */

// Mobile device detection and read-only mode
const MobileMode = {
    isMobile: function () {
        return window.innerWidth <= 768 || /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    },

    init: function () {
        if (!this.isMobile()) return;

        // Make editor read-only
        const editor = document.getElementById('editor');
        if (editor) {
            editor.contentEditable = 'false';
            editor.style.cursor = 'default';
            editor.style.userSelect = 'text'; // Allow selection for copy
        }

        // Hide sidebar and toolbars
        document.body.classList.add('mobile-mode');

        // Double-tap handler for print menu
        this.initDoubleTapPrint();
    },

    initDoubleTapPrint: function () {
        const chipsBar = document.getElementById('chips-scroll-container');
        if (!chipsBar) return;

        let lastTap = 0;
        let lastTappedChip = null;

        chipsBar.addEventListener('touchend', (e) => {
            const chip = e.target.closest('.chip');
            if (!chip) return;

            const noteId = chip.id.replace('chip-', '');
            const currentTime = new Date().getTime();
            const tapGap = currentTime - lastTap;

            if (tapGap < 300 && tapGap > 0 && lastTappedChip === chip) {
                // Double tap detected
                e.preventDefault();
                this.showPrintMenu(noteId, e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            }

            lastTap = currentTime;
            lastTappedChip = chip;
        });
    },

    showPrintMenu: function (noteId, x, y) {
        // Remove existing menu if any
        const existing = document.getElementById('mobile-print-menu');
        if (existing) existing.remove();

        const menu = document.createElement('div');
        menu.id = 'mobile-print-menu';
        menu.className = 'mobile-print-menu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';

        const printItem = document.createElement('div');
        printItem.className = 'mobile-menu-item';
        printItem.innerHTML = '<i class="ph ph-printer"></i><span>Print Note</span>';
        printItem.onclick = () => {
            menu.remove();
            // Set note as active and trigger print
            Store.activeId = noteId;
            UI.loadNoteContent();
            setTimeout(() => UI.openModal('export'), 100);
        };

        menu.appendChild(printItem);
        document.body.appendChild(menu);

        // Close on outside tap
        setTimeout(() => {
            document.addEventListener('touchend', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('touchend', closeMenu);
                }
            });
        }, 100);
    }
};

// Initialize on DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => MobileMode.init());
} else {
    MobileMode.init();
}

/* ================================
   SOURCE: js/logic.js
   PURPOSE: Editor logic, formatting, search, and export features
   ================================ */

// js/logic.js
const Logic = {
    lastSelectionRange: null,

    saveSelection: function () {
        const sel = window.getSelection();
        if (sel.rangeCount > 0 && UI.els.editor.contains(sel.anchorNode)) {
            this.lastSelectionRange = sel.getRangeAt(0).cloneRange();
        }
    },

    restoreSelection: function () {
        if (this.lastSelectionRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(this.lastSelectionRange);
        }
    },

    // --- Focus Mode Logic ---
    highlightActiveBlock: function () {
        if (!UI.els.editor.classList.contains('focus-mode-active')) return;

        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        let node = sel.anchorNode;
        if (node.nodeType === 3) node = node.parentNode;

        while (node && node.parentNode !== UI.els.editor && node !== UI.els.editor) {
            node = node.parentNode;
        }

        const existing = UI.els.editor.querySelectorAll('.focused-block');
        existing.forEach(el => el.classList.remove('focused-block'));

        if (node && node !== UI.els.editor && node.parentNode === UI.els.editor) {
            node.classList.add('focused-block');
        }
    },

    // --- Share Logic ---
    toggleShare: async function (checked) {
        const linkBox = document.getElementById('share-link-box');
        if (checked) linkBox.classList.add('active');
        else linkBox.classList.remove('active');
        await Store.togglePublicStatus(Store.activeId, checked);
    },

    copyShareLink: function () {
        const input = document.querySelector('.link-input');
        input.select();
        document.execCommand('copy');
        navigator.clipboard.writeText(input.value);
        const btn = document.getElementById('btn-copy');
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = "Copy", 1500);
    },

    // --- Pin/Unpin Logic ---
    togglePinNote: async function () {
        const note = Store.getActiveNote();
        if (!note) {
            console.log('No active note found');
            return;
        }

        console.log('Current note:', note.title, 'is_pinned:', note.is_pinned);
        const newPinStatus = !note.is_pinned;
        console.log('Toggling to:', newPinStatus);

        const result = await Store.togglePinStatus(Store.activeId, newPinStatus);
        console.log('Toggle result:', result);

        UI.renderChips();
        this.updatePinButton();
    },

    updatePinButton: function () {
        const note = Store.getActiveNote();
        const btn = document.getElementById('btn-pin');
        const text = document.getElementById('pin-text');

        if (note && note.is_pinned) {
            if (text) text.innerText = 'Pinned';
            if (btn) btn.style.opacity = '1';
        } else {
            if (text) text.innerText = 'Pin';
            if (btn) btn.style.opacity = '0.7';
        }
    },

    // --- Export Logic ---
    exportNote: function (format) {
        const note = Store.getActiveNote();
        if (!note) return;

        const filename = `${note.title.replace(/[^a-z0-9]/gi, '_')}`;

        if (format === 'pdf') {
            // UX IMPROVEMENT: Show loading state
            const btns = document.querySelectorAll('.export-option-btn');
            let pdfBtn = null;
            btns.forEach(b => {
                if (b.innerText.includes('PDF')) pdfBtn = b;
            });

            if (pdfBtn) {
                // Prevent double clicks
                if (pdfBtn.disabled) return;

                const originalHTML = pdfBtn.innerHTML;
                pdfBtn.style.opacity = '0.7';
                pdfBtn.style.cursor = 'wait';
                pdfBtn.disabled = true;

                // Show clear loading indicator
                pdfBtn.innerHTML = `
                    <i class="ph ph-spinner ph-spin"></i>
                    <div>
                        <div class="export-title">Generating PDF...</div>
                        <div class="export-desc">Please wait</div>
                    </div>
                `;

                // Defer the heavy lifting to allow UI to update
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        try {
                            this.exportToPDF(note, () => {
                                // Callback after export window opens
                                pdfBtn.innerHTML = originalHTML;
                                pdfBtn.style.opacity = '1';
                                pdfBtn.style.cursor = 'pointer';
                                pdfBtn.disabled = false;
                                UI.closeModal();
                            });
                        } catch (e) {
                            console.error('Export failed', e);
                            pdfBtn.innerHTML = `<i class="ph ph-warning"></i> Error`;
                            setTimeout(() => {
                                pdfBtn.innerHTML = originalHTML;
                                pdfBtn.style.opacity = '1';
                                pdfBtn.style.cursor = 'pointer';
                                pdfBtn.disabled = false;
                            }, 2000);
                        }
                    }, 50); // Small delay to ensure render
                });
            } else {
                // Fallback if button not found (rare)
                this.exportToPDF(note);
                UI.closeModal();
            }
        } else if (format === 'markdown') {
            this.exportToMarkdown(note, filename);
            UI.closeModal();
        } else if (format === 'text') {
            this.exportToText(note, filename);
            UI.closeModal();
        }
    },

    exportToPDF: function (note, onComplete) {
        const editor = document.getElementById('editor');
        if (!editor) {
            console.error('Editor not found');
            if (onComplete) onComplete();
            return;
        }

        // Update the dynamic print style with A2 portrait and zero margins
        const printStyle = document.getElementById('print-page-style');
        if (printStyle) {
            printStyle.textContent = `
                @media print {
                    @page {
                        size: A2 portrait;
                        margin: 0;
                    }
                }
            `;
        }

        // Small delay to ensure styles are applied before print dialog opens
        setTimeout(() => {
            window.print();
            // Call completion callback after print dialog closes
            if (onComplete) onComplete();
        }, 100);
    },

    exportToMarkdown: function (note, filename) {
        let markdown = `# ${note.title}\n\n`;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;

        markdown += this.htmlToMarkdown(tempDiv);

        this.downloadFile(markdown, `${filename}.md`, 'text/markdown');
    },

    exportToText: function (note, filename) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;
        const text = `${note.title}\n\n${tempDiv.innerText}`;

        this.downloadFile(text, `${filename}.txt`, 'text/plain');
    },

    htmlToMarkdown: function (element) {
        let markdown = '';

        element.childNodes.forEach(node => {
            if (node.nodeType === 3) {
                markdown += node.textContent;
            } else if (node.nodeType === 1) {
                const tag = node.tagName.toLowerCase();

                if (tag === 'h1') markdown += `# ${node.innerText}\n\n`;
                else if (tag === 'h2') markdown += `## ${node.innerText}\n\n`;
                else if (tag === 'h3') markdown += `### ${node.innerText}\n\n`;
                else if (tag === 'p') markdown += `${node.innerText}\n\n`;
                else if (tag === 'strong' || tag === 'b') markdown += `**${node.innerText}**`;
                else if (tag === 'em' || tag === 'i') markdown += `*${node.innerText}*`;
                else if (tag === 'u') markdown += `__${node.innerText}__`;
                else if (tag === 'ul') {
                    node.querySelectorAll('li').forEach(li => {
                        markdown += `- ${li.innerText}\n`;
                    });
                    markdown += '\n';
                } else if (tag === 'ol') {
                    node.querySelectorAll('li').forEach((li, i) => {
                        markdown += `${i + 1}. ${li.innerText}\n`;
                    });
                    markdown += '\n';
                } else if (tag === 'pre' || tag === 'code') {
                    markdown += `\`\`\`\n${node.innerText}\n\`\`\`\n\n`;
                } else if (tag === 'br') {
                    markdown += '\n';
                } else {
                    markdown += this.htmlToMarkdown(node);
                }
            }
        });

        return markdown;
    },

    downloadFile: function (content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    },

    switchNote: function (id) {
        Store.saveImmediate();
        Store.activeId = id;
        UI.renderChips();
        UI.loadNoteContent();
        UI.updateStats();
    },

    // --- Formatting ---
    restoreSelection: function () {
        UI.els.editor.focus();
        if (this.lastSelectionRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(this.lastSelectionRange);
        }
    },

    checkToolbarState: function () {
        const commands = [
            'bold', 'italic', 'underline',
            'insertUnorderedList', 'insertOrderedList',
            'justifyLeft', 'justifyCenter', 'justifyRight'
        ];

        commands.forEach(cmd => {
            let btnId;
            if (cmd === 'insertUnorderedList') btnId = 'btn-ul';
            else if (cmd === 'insertOrderedList') btnId = 'btn-ol';
            else if (cmd.startsWith('justify')) btnId = 'btn-' + cmd;
            else btnId = 'btn-' + cmd;

            const btn = document.getElementById(btnId);
            try {
                if (btn) {
                    if (document.queryCommandState(cmd)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            } catch (e) { }
        });

        try {
            const color = document.queryCommandValue('foreColor');
            this.updateColorIndicator(color);
        } catch (e) { }
    },

    updateColorIndicator: function (color) {
        const indicator = document.getElementById('color-indicator');
        if (!indicator) return;
        const isWhite = color === 'rgb(255, 255, 255)' || color === '#ffffff' || color === 'white' || color === 'rgba(0, 0, 0, 0)';
        if (color && !isWhite) {
            indicator.style.backgroundColor = color;
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none';
        }
    },

    formatText: function (cmd, value = null) {
        document.execCommand(cmd, false, value);
        this.checkToolbarState();
        document.getElementById('editor').focus();
    },

    formatHeading: function (tag) {
        document.execCommand('formatBlock', false, tag);
        this.checkToolbarState();
    },

    setTextColor: function (color) {
        this.restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);

        if (range.collapsed) {
            // 1. Cursor Only: Insert colored span with ZWS
            const span = document.createElement('span');
            span.style.color = color;
            span.innerHTML = '&#8203;'; // Zero-width space
            range.insertNode(span);

            // Move cursor inside
            const newRange = document.createRange();
            newRange.setStart(span.firstChild, 1); // After ZWS
            newRange.collapse(true);
            sel.removeAllRanges();
            sel.addRange(newRange);
        } else {
            // 2. Selection: Wrap text
            try {
                const span = document.createElement('span');
                span.style.color = color;

                try {
                    range.surroundContents(span);
                } catch (e) {
                    const content = range.extractContents();
                    span.appendChild(content);
                    range.insertNode(span);
                }
            } catch (err) {
                console.error("Color wrap failed", err);
            }
        }

        UI.closeAllMenus();
        Store.save();
        this.updateColorIndicator(color);
    },

    setFont: function (fontName) {
        if (!document.getElementById('font-box').classList.contains('active')) return;
        this.restoreSelection();
        document.execCommand('fontName', false, fontName);
        UI.closeAllMenus();
        Store.save();
    },

    applyHeading: function (tag) {
        if (!document.getElementById('heading-box').classList.contains('active')) return;
        this.restoreSelection();

        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            document.execCommand('formatBlock', false, tag);
        }

        UI.closeAllMenus();
        Store.save();
    },

    changeFontSize: function (delta) {
        this.restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const clamp = (val) => Math.max(12, Math.min(48, val));

        const getComputedSize = (node) => {
            const el = node.nodeType === 1 ? node : node.parentElement;
            if (!el) return 18;
            return parseFloat(window.getComputedStyle(el).fontSize) || 18;
        };

        const applySize = (node, size) => {
            if (node.nodeType === 1) {
                node.style.fontSize = size + 'px';
                node.style.lineHeight = '1.7';
                node.style.margin = '0';
                node.style.padding = '0';
                node.style.display = 'inline';
            }
        };

        if (sel.isCollapsed) {
            // Cursor Logic
            let node = sel.anchorNode;
            if (node.nodeType === 3) node = node.parentNode;

            let curr = node;
            while (curr && curr.id !== 'editor' && (!curr.style || !curr.style.fontSize)) {
                curr = curr.parentNode;
            }

            const currentSize = getComputedSize(curr && curr.id !== 'editor' ? curr : node);
            const newSize = clamp(currentSize + delta);

            if (curr && curr.tagName === 'SPAN' && curr.style.fontSize && curr.id !== 'editor') {
                curr.style.fontSize = newSize + 'px';
            } else {
                const span = document.createElement('span');
                applySize(span, newSize);
                span.innerHTML = '&#8203;';
                const range = sel.getRangeAt(0);
                range.insertNode(span);
                range.setStart(span, 1);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        } else {
            // Range Logic
            let range = sel.getRangeAt(0);

            // Clean boundaries
            let start = range.startContainer;
            let end = range.endContainer;

            if (start.nodeType === 3 && range.startOffset > 0 && range.startOffset < start.length) {
                const split = start.splitText(range.startOffset);
                range.setStart(split, 0);
            }
            if (end.nodeType === 3 && range.endOffset < end.length && range.endOffset > 0) {
                end.splitText(range.endOffset);
            }

            const getTextNodes = (r) => {
                const nodes = [];
                const iterator = document.createNodeIterator(
                    r.commonAncestorContainer,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: (node) => {
                            return r.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                        }
                    }
                );
                let currentNode;
                while (currentNode = iterator.nextNode()) {
                    if (currentNode.length > 0) nodes.push(currentNode);
                }
                return nodes;
            };

            const nodes = getTextNodes(range);
            let firstNode = null;
            let lastNode = null;

            nodes.forEach((node, index) => {
                const size = getComputedSize(node);
                const newSize = clamp(size + delta);
                const p = node.parentElement;

                let targetNode = node;

                if (p.tagName === 'SPAN' && p.style.fontSize && p.childNodes.length === 1 && p.id !== 'editor') {
                    applySize(p, newSize);
                    targetNode = p;
                } else {
                    const span = document.createElement('span');
                    applySize(span, newSize);
                    node.replaceWith(span);
                    span.appendChild(node);
                    targetNode = span;
                }

                if (index === 0) firstNode = targetNode;
                lastNode = targetNode;
            });

            if (firstNode && lastNode) {
                sel.removeAllRanges();
                const newRange = document.createRange();
                newRange.setStartBefore(firstNode);
                newRange.setEndAfter(lastNode);
                sel.addRange(newRange);
                this.saveSelection();
            }
        }
        Store.save();
    },

    // Clean pasted content to remove unwanted formatting
    cleanPastedContent: function () {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const range = sel.getRangeAt(0);
        const fragment = range.extractContents();
        const walker = document.createTreeWalker(fragment, NodeFilter.SHOW_ELEMENT, null, false);

        let node;
        const elementsToRemove = [];

        while (node = walker.nextNode()) {
            // Remove style attributes from most elements
            if (node.style) {
                node.removeAttribute('style');
            }

            // Remove specific unwanted tags
            if (node.tagName === 'DIV' && node.parentNode === fragment) {
                // Convert div to p for better structure
                const p = document.createElement('p');
                while (node.firstChild) {
                    p.appendChild(node.firstChild);
                }
                node.parentNode.replaceChild(p, node);
            }

            // Clean up font tags
            if (node.tagName === 'FONT') {
                const span = document.createElement('span');
                if (node.color) span.style.color = node.color;
                if (node.face) span.style.fontFamily = node.face;
                if (node.size) {
                    const sizeMap = { 1: '10px', 2: '13px', 3: '16px', 4: '18px', 5: '24px', 6: '32px', 7: '48px' };
                    span.style.fontSize = sizeMap[node.size] || '16px';
                }
                while (node.firstChild) {
                    span.appendChild(node.firstChild);
                }
                node.parentNode.replaceChild(span, node);
            }
        }

        // Insert cleaned content
        range.insertNode(fragment);

        // Normalize the content
        range.commonAncestorContainer.normalize();

        Store.save();
    },

    // --- REFACTORED: Code Block with Syntax Highlighting ---
    formatCodeBlock: function () {
        this.restoreSelection();

        const selection = window.getSelection();
        let text = selection.toString();

        if (!text) text = "Type your code here...";

        // 1. Escape HTML Entities (Crucial first step)
        text = text.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        // 2. Syntax Highlighting (Regex Replacement)
        // A. Strings (Double and Single Quotes)
        text = text.replace(/(['"`])(?:(?!\1)[^\\]|\\.)*\1/g, '<span class="code-string">$&</span>');

        // B. Comments (Double Slash)
        text = text.replace(/(\/\/[^\n]*)/g, '<span class="code-comment">$1</span>');

        // C. Keywords (Boundaries \b)
        const keywords = 'const|let|var|function|return|if|else|for|while|class|import|from|async|await|try|catch|new|this|typeof';
        const kwRegex = new RegExp(`\\b(${keywords})\\b`, 'g');

        text = text.replace(kwRegex, (match) => {
            return `<span class="code-keyword">${match}</span>`;
        });

        // D. Numbers
        text = text.replace(/\b(\d+)\b/g, '<span class="code-number">$1</span>');

        const html = `<pre class="code-block"><code>${text}</code></pre><p><br></p>`;

        document.execCommand('insertHTML', false, html);
        Store.save();
    },

    insertDivider: function (type) {
        this.restoreSelection();
        const hr = `<hr class="custom-divider divider-${type}" contenteditable="false">`;
        document.execCommand('insertHTML', false, hr + '<p><br></p>');
        Store.save();
    },

    handleListInput: function (e) {
        if (e.shiftKey || (e.key !== 'Enter' && e.key !== 'Backspace')) return;
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        let node = sel.anchorNode;
        if (node.nodeType === 3) node = node.parentNode;
        const li = node.closest('li');
        if (!li) return;
        const cleanText = li.innerText.replace(/\u200B/g, '').trim();
        const hasContent = cleanText.length > 0 || !!li.querySelector('img') || !!li.querySelector('svg');
        if (!hasContent) {
            e.preventDefault();
            document.execCommand('outdent', false, null);
        }
    },

    handleMarkdownTriggers: function (e) {
        // === LISTS: Trigger on SPACE ===
        if (e.key === ' ') {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            let node = range.startContainer;

            if (node.nodeType === 3) {
                const text = node.textContent;

                // Unordered list: "-"
                if (text.endsWith('-') && text.trim() === '-') {
                    e.preventDefault();
                    document.execCommand('delete', false);
                    document.execCommand('insertUnorderedList', false);
                    return;
                }
                // Ordered list: "1."
                if (text.endsWith('1.') && text.trim() === '1.') {
                    e.preventDefault();
                    document.execCommand('delete', false);
                    document.execCommand('delete', false);
                    document.execCommand('insertOrderedList', false);
                    return;
                }
            }
        }
    },

    // Helper: Convert current block to heading and create new paragraph
    convertToHeading: function (node, tag, content) {
        // Create new heading element
        const newHeader = document.createElement(tag);

        // Parse content for color shortcuts
        const { cleanText, color } = this.parseColorShortcut(content);

        if (color) {
            newHeader.innerHTML = `<span style="color: ${color}">${cleanText || ''}</span>`;
        } else {
            newHeader.textContent = cleanText || '';
        }

        // Replace current node with heading
        if (node.parentNode) {
            node.parentNode.replaceChild(newHeader, node);
        }

        // Create new empty paragraph below for typing (default styles)
        const newP = document.createElement('p');
        newP.innerHTML = '<br>';
        newHeader.after(newP);

        // Move cursor to the new paragraph
        const range = document.createRange();
        const sel = window.getSelection();
        range.setStart(newP, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);

        Store.save();
    },

    // Helper: Extract color shortcut from text
    parseColorShortcut: function (text) {
        const colorMap = {
            'red': '#f87171', 'blue': '#60a5fa', 'green': '#4ade80',
            'yellow': '#facc15', 'pink': '#f472b6', 'violet': '#c084fc',
            'orange': '#fb923c', 'purple': '#a855f7', 'gray': '#9ca3af',
            'white': '#ffffff', 'cyan': '#22d3ee', 'magenta': '#e879f9',
            'lime': '#a3e635', 'indigo': '#818cf8', 'teal': '#2dd4bf'
        };

        const match = text.match(/@([a-zA-Z]+)/);
        if (match) {
            const colorName = match[1].toLowerCase();
            if (colorMap[colorName]) {
                return {
                    cleanText: text.replace(/@[a-zA-Z]+\s*/g, '').trim(),
                    color: colorMap[colorName]
                };
            }
        }
        return { cleanText: text, color: null };
    },

    // --- SEARCH ---
    searchResults: [],
    currentSearchIndex: -1,
    isSearching: false,

    performSearch: function (term) {
        this.clearSearch();
        if (!term || term.length < 2) return;
        const editor = UI.els.editor;
        const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
        const nodes = [];
        let node;
        while (node = walker.nextNode()) nodes.push(node);
        const regex = new RegExp(`(${term})`, 'gi');
        let matchCount = 0;
        nodes.forEach(textNode => {
            if (textNode.nodeValue && textNode.nodeValue.match(regex)) {
                const parent = textNode.parentNode;
                if (parent.tagName === 'MARK') return;
                const frag = document.createDocumentFragment();
                let lastIdx = 0;
                textNode.nodeValue.replace(regex, (match, p1, offset) => {
                    const before = textNode.nodeValue.slice(lastIdx, offset);
                    if (before) frag.appendChild(document.createTextNode(before));
                    const mark = document.createElement('mark');
                    mark.className = 'search-highlight';
                    mark.textContent = match;
                    frag.appendChild(mark);
                    lastIdx = offset + match.length;
                    matchCount++;
                    return match;
                });
                const remaining = textNode.nodeValue.slice(lastIdx);
                if (remaining) frag.appendChild(document.createTextNode(remaining));
                parent.replaceChild(frag, textNode);
            }
        });
        if (matchCount > 0) {
            this.searchResults = document.querySelectorAll('.search-highlight');
            this.currentSearchIndex = -1;
            this.isSearching = true;
            this.findNextMatch();
        }
    },

    findNextMatch: function () {
        if (!this.searchResults.length) return;
        if (this.currentSearchIndex >= 0 && this.searchResults[this.currentSearchIndex]) {
            this.searchResults[this.currentSearchIndex].classList.remove('current');
        }
        this.currentSearchIndex++;
        if (this.currentSearchIndex >= this.searchResults.length) this.currentSearchIndex = 0;
        const el = this.searchResults[this.currentSearchIndex];
        el.classList.add('current');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    },

    clearSearch: function () {
        const marks = UI.els.editor.querySelectorAll('mark.search-highlight');
        marks.forEach(mark => {
            const parent = mark.parentNode;
            parent.replaceChild(document.createTextNode(mark.textContent), mark);
            parent.normalize();
        });
        this.searchResults = [];
        this.currentSearchIndex = -1;
        this.isSearching = false;
    },

    handleInput: function (e) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const node = sel.anchorNode;
        if (node.nodeType !== 3) return;

        const text = node.textContent;
        const offset = sel.anchorOffset;

        // Helper to find block parent
        let getBlockParent = (n) => {
            let curr = n;
            while (curr && curr.id !== 'editor') {
                if (curr.tagName && ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'PRE'].includes(curr.tagName)) {
                    return curr;
                }
                curr = curr.parentNode;
            }
            return null;
        };

        // === SHORTCUTS TRIGGERED ON COLON (:) ===
        if (e.data === ':') {
            const textBefore = text.slice(0, offset).trim();
            let parent = node.parentNode;
            while (parent && parent.nodeType === 3) parent = parent.parentNode;

            // --- CODE BLOCK SHORTCUT ($code:) ---
            if (textBefore === '$code:' || textBefore.match(/^\s*\$code:$/)) {
                if (parent && (parent.tagName === 'P' || parent.tagName === 'DIV' || parent.id === 'editor')) {
                    e.preventDefault();

                    const pre = document.createElement('pre');
                    pre.className = 'code-block';
                    const code = document.createElement('code');
                    code.textContent = 'Type your code here...';

                    pre.appendChild(code);

                    if (parent.id === 'editor') {
                        const range = sel.getRangeAt(0);
                        range.setStart(node, 0);
                        range.setEnd(node, offset);
                        range.deleteContents();
                        range.insertNode(pre);
                    } else {
                        parent.replaceWith(pre);
                    }

                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    pre.after(p);

                    const range = document.createRange();
                    range.selectNodeContents(code);
                    sel.removeAllRanges();
                    sel.addRange(range);

                    Store.save();
                    return;
                }
            }

            // --- H1 HEADING SHORTCUT (#head:) ---
            if (textBefore === '#head:' || textBefore.match(/^\s*#head:$/)) {
                if (parent && (parent.tagName === 'P' || parent.tagName === 'DIV' || parent.id === 'editor')) {
                    e.preventDefault();

                    const h1 = document.createElement('h1');
                    h1.innerHTML = '\u200B';

                    if (parent.id === 'editor') {
                        const range = sel.getRangeAt(0);
                        range.setStart(node, 0);
                        range.setEnd(node, offset);
                        range.deleteContents();
                        range.insertNode(h1);
                    } else {
                        parent.replaceWith(h1);
                    }

                    const range = document.createRange();
                    range.setStart(h1, 0);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);

                    Store.save();
                    return;
                }
            }

            // --- H2 HEADING SHORTCUT (#subHead:) ---
            if (textBefore === '#subHead:' || textBefore.match(/^\s*#subHead:$/)) {
                if (parent && (parent.tagName === 'P' || parent.tagName === 'DIV' || parent.id === 'editor')) {
                    e.preventDefault();

                    const h2 = document.createElement('h2');
                    h2.innerHTML = '\u200B';

                    if (parent.id === 'editor') {
                        const range = sel.getRangeAt(0);
                        range.setStart(node, 0);
                        range.setEnd(node, offset);
                        range.deleteContents();
                        range.insertNode(h2);
                    } else {
                        parent.replaceWith(h2);
                    }

                    const range = document.createRange();
                    range.setStart(h2, 0);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);

                    Store.save();
                    return;
                }
            }
        }

        // === COLOR SHORTCUT (@color + space) ===
        if (e.data === ' ') {
            // First check for $code: shortcut
            const textBeforeSpace = text.slice(0, offset - 1).trim();
            if (textBeforeSpace === '$code:') {
                let parent = node.parentNode;
                while (parent && parent.nodeType === 3) parent = parent.parentNode;

                if (parent && (parent.tagName === 'P' || parent.tagName === 'DIV' || parent.id === 'editor')) {
                    e.preventDefault();

                    // Remove the $code: and space
                    const pre = document.createElement('pre');
                    pre.className = 'code-block';
                    const code = document.createElement('code');
                    code.textContent = 'Type your code here...';
                    pre.appendChild(code);

                    // Clear the text
                    node.textContent = '';

                    if (parent.id === 'editor') {
                        const range = document.createRange();
                        range.setStart(node, 0);
                        range.collapse(true);
                        range.insertNode(pre);
                    } else {
                        parent.replaceWith(pre);
                    }

                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    pre.after(p);

                    const newRange = document.createRange();
                    newRange.selectNodeContents(code);
                    sel.removeAllRanges();
                    sel.addRange(newRange);

                    Store.save();
                    return;
                }
            }

            // Then check for color shortcut
            const textBeforeCursor = text.slice(0, offset - 1);
            const match = textBeforeCursor.match(/@([a-zA-Z]+)$/);

            if (match) {
                const colorName = match[1].toLowerCase();
                const colorMap = {
                    'red': '#f87171', 'blue': '#60a5fa', 'green': '#4ade80',
                    'yellow': '#facc15', 'pink': '#f472b6', 'violet': '#c084fc',
                    'orange': '#fb923c', 'purple': '#a855f7', 'gray': '#9ca3af',
                    'white': '#ffffff', 'cyan': '#22d3ee', 'magenta': '#e879f9',
                    'lime': '#a3e635', 'indigo': '#818cf8', 'teal': '#2dd4bf',
                    'black': '#1f2937', 'brown': '#a16207'
                };

                if (colorMap[colorName]) {
                    const hexColor = colorMap[colorName];
                    const matchIndex = match.index;
                    const matchLength = match[0].length + 1; // +1 for space

                    const range = document.createRange();
                    range.setStart(node, matchIndex);
                    range.setEnd(node, matchIndex + matchLength);
                    range.deleteContents();

                    const span = document.createElement('span');
                    span.style.color = hexColor;
                    span.innerHTML = '\u200B';

                    range.insertNode(span);

                    range.setStart(span, 1);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);

                    this.updateColorIndicator(hexColor);
                    Store.save();
                    return;
                }
            }
        }
    },

    // NEW: Enter key fallback handler for shortcuts
    handleEnterShortcuts: function (e) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        let node = sel.anchorNode;
        if (node.nodeType === 3) node = node.parentNode;

        // Find block parent
        let block = node;
        while (block && block.id !== 'editor') {
            if (block.tagName && ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(block.tagName)) {
                break;
            }
            block = block.parentNode;
        }

        if (!block || block.id === 'editor') return;

        const blockText = block.textContent.trim();

        // Check for #head: at line start
        if (blockText.startsWith('#head:')) {
            e.preventDefault();
            const content = blockText.substring(6).trim();
            const h1 = document.createElement('H1');
            h1.textContent = content || '\u200B';
            block.replaceWith(h1);

            const p = document.createElement('p');
            p.innerHTML = '<br>';
            h1.after(p);

            const range = document.createRange();
            range.setStart(p, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);

            Store.save();
            return;
        }

        // Check for #subHead: at line start
        if (blockText.startsWith('#subHead:')) {
            e.preventDefault();
            const content = blockText.substring(9).trim();
            const h2 = document.createElement('H2');
            h2.textContent = content || '\u200B';
            block.replaceWith(h2);

            const p = document.createElement('p');
            p.innerHTML = '<br>';
            h2.after(p);

            const range = document.createRange();
            range.setStart(p, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);

            Store.save();
            return;
        }

        // Check for $code: at line start
        if (blockText.startsWith('$code:')) {
            e.preventDefault();
            const content = blockText.substring(6).trim();

            const pre = document.createElement('pre');
            pre.className = 'code-block';
            const code = document.createElement('code');
            code.textContent = content || 'Type your code here...';
            pre.appendChild(code);

            block.replaceWith(pre);

            const p = document.createElement('p');
            p.innerHTML = '<br>';
            pre.after(p);

            const range = document.createRange();
            range.setStart(p, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);

            Store.save();
            return;
        }
    },

    installPWA: async function () {
        if (!this.deferredPrompt) return;
        this.deferredPrompt.prompt();
        const { outcome } = await this.deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            this.deferredPrompt = null;
            document.getElementById('btn-install').style.display = 'none';
        }
    }
};

/* ================================
   SOURCE: js/main.js (partial - only initApp function)
   PURPOSE: App initialization and event listeners setup
   NOTE: This runs after all objects are defined
   ================================ */

async function initApp() {
    UI.cacheElements();
    await Auth.init();
    await Store.init();
    UI.renderChips();
    UI.loadNoteContent();

    document.execCommand('defaultParagraphSeparator', false, 'p');

    setupListeners();
}

function setupListeners() {
    // Context menu clicks (already handled in chip-context-menu section)

    // Editor Events
    UI.els.editor.addEventListener('mouseup', () => {
        Logic.checkToolbarState();
        Logic.saveSelection();
        Logic.highlightActiveBlock();
    });
    UI.els.editor.addEventListener('keyup', (e) => {
        Logic.checkToolbarState();
        Logic.saveSelection();
        Logic.highlightActiveBlock();
    });

    // --- KEYBOARD MANAGER ---
    document.addEventListener('keydown', (e) => {
        // 1. CTRL + F Override
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
            e.preventDefault();
            if (!UI.isModalOpen()) {
                if (!UI.els.findBar.classList.contains('visible')) {
                    UI.toggleFind();
                } else {
                    UI.els.findInput.focus();
                    UI.els.findInput.select();
                }
            }
            return;
        }

        // 2. ESC Priority Stack (LIFO)
        if (e.key === 'Escape') {
            // Priority 1: Floating Menus
            if (document.querySelector('.floating-menu.active')) {
                UI.closeAllMenus();
                e.preventDefault();
                return;
            }
            // Priority 2: Main Modal (Overlay is on top of Search)
            if (UI.els.modalOverlay.classList.contains('visible')) {
                UI.closeModal();
                e.preventDefault();
                return;
            }
            // Priority 3: Search
            if (UI.els.findBar.classList.contains('visible')) {
                UI.toggleFind();
                e.preventDefault();
                return;
            }
            // Priority 4: Zen Mode
            if (document.body.classList.contains('zen-active')) {
                UI.toggleZen();
                e.preventDefault();
                return;
            }
            // Priority 5: Mobile Sidebar (Close if Open)
            if (UI.els.sidebar.classList.contains('active')) {
                UI.toggleSidebar();
                e.preventDefault();
                return;
            }
            // Priority 6: Settings Modal
            const settingsModal = document.getElementById('settings-modal-overlay');
            if (settingsModal && settingsModal.style.display === 'flex') {
                UI.closeSettingsModal();
                e.preventDefault();
                return;
            }
        }
    });

    // Editor Shortcuts
    UI.els.editor.addEventListener('keydown', (e) => {
        // Handle paste event for better formatting
        if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
            setTimeout(() => {
                Logic.cleanPastedContent();
            }, 0);
        }

        // Handle Shortcut Fallback on Enter (MUST run first)
        if (e.key === 'Enter') {
            Logic.handleEnterShortcuts(e);
            // If shortcut was detected, event is prevented and we return early
            if (e.defaultPrevented) return;

            // Check if we're in a heading - if so, create clean paragraph after
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                let node = sel.anchorNode;
                if (node.nodeType === 3) node = node.parentNode;

                // Find if we're in a heading
                let current = node;
                while (current && current.id !== 'editor') {
                    if (current.tagName && ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(current.tagName)) {
                        // We're in a heading - need to ensure next line is paragraph
                        e.preventDefault();

                        // Create new paragraph
                        const p = document.createElement('p');
                        p.innerHTML = '<br>';
                        current.after(p);

                        // Move cursor to new paragraph
                        const range = document.createRange();
                        range.setStart(p, 0);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);

                        return;
                    }
                    current = current.parentNode;
                }
            }
        }

        // Handle Markdown Triggers (Headings on Enter)
        Logic.handleMarkdownTriggers(e);

        // Handle List Logic (Enter & Backspace)
        if (e.key === 'Enter' || e.key === 'Backspace') {
            Logic.handleListInput(e);
        }

        // Update focus mode on Enter/Arrow keys
        if (e.key === 'Enter' || e.key.startsWith('Arrow')) {
            setTimeout(() => Logic.highlightActiveBlock(), 10);
        }

        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.execCommand('insertParagraph', false, null);
            document.execCommand('formatBlock', false, 'p');
            document.execCommand('removeFormat', false, null);
            document.execCommand('unlink', false, null);
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('hiliteColor', false, 'transparent');
            document.execCommand('foreColor', false, '#e0e0e0');
            document.execCommand('styleWithCSS', false, false);
            document.execCommand('fontName', false, 'Fredoka');
            document.execCommand('fontSize', false, '3');
        }
    });

    // Click below content
    UI.els.container.addEventListener('click', (e) => {
        if (e.target === UI.els.container || e.target === UI.els.editor) {
            UI.els.editor.focus();
            const lastChild = UI.els.editor.lastElementChild;
            if (lastChild && (lastChild.tagName === 'PRE' || lastChild.tagName === 'DIV' || lastChild.style.backgroundColor)) {
                const p = document.createElement('p');
                p.innerHTML = '<br>';
                UI.els.editor.appendChild(p);
                const range = document.createRange();
                range.selectNodeContents(p);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                Logic.saveSelection();
            }
        }
    });

    // Auto Save
    UI.els.editor.addEventListener('input', (e) => {
        Logic.handleInput(e);
        UI.checkPlaceholder();
        UI.updateStats();
        Store.save();
        Logic.saveSelection();
    });

    // Search
    UI.els.findInput.addEventListener('input', (e) => {
        Logic.performSearch(e.target.value);
    });

    UI.els.findInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            Logic.findNextMatch();
        }
    });

    // Bindings
    document.getElementById('new-note-btn').onclick = () => UI.openModal('create');
    document.getElementById('desk-delete').onclick = () => UI.openModal('delete-confirm', Store.activeId);
    document.getElementById('m-btn-delete').onclick = () => UI.openModal('delete-confirm', UI.targetId);

    UI.els.btnConfirm.onclick = () => UI.handleModalConfirm();
    UI.els.btnCancel.onclick = () => UI.closeModal();

    // Modal Enter Key Support
    if (UI.els.mInput) {
        UI.els.mInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') UI.handleModalConfirm();
        });
    }

    // PWA Install Logic
    const installBtn = document.getElementById('btn-install-sidebar');

    if (installBtn) {
        installBtn.onclick = () => Logic.installPWA();
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        Logic.deferredPrompt = e;
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
    });

    window.addEventListener('appinstalled', () => {
        if (installBtn) {
            installBtn.style.display = 'none';
        }
        Logic.deferredPrompt = null;
    });
}

js/settings.js 
/* ================================
   SETTINGS & THEME SYSTEM
   PURPOSE: Theme management, settings UI, and preferences persistence
   ================================ */

const Settings = {
    // Default settings
    defaults: {
        theme: 'dark',
        editorFont: 'Playpen Sans',
        editorFontSize: '18',
        autoSave: true
    },

    // Current settings
    current: {},

    // Initialize settings
    init: function() {
        this.loadSettings();
        this.applySettings();
        this.bindEvents();
    },

    // Load settings from localStorage
    loadSettings: function() {
        const saved = localStorage.getItem('focuspad_settings');
        if (saved) {
            try {
                this.current = JSON.parse(saved);
            } catch (e) {
                this.current = { ...this.defaults };
            }
        } else {
            this.current = { ...this.defaults };
        }
    },

    // Save settings to localStorage
    saveSettings: function() {
        localStorage.setItem('focuspad_settings', JSON.stringify(this.current));
    },

    // Apply all settings to the UI
    applySettings: function() {
        // Apply theme
        this.setTheme(this.current.theme || this.defaults.theme);
        
        // Apply editor font
        if (this.current.editorFont) {
            this.setEditorFont(this.current.editorFont);
            const fontSelect = document.getElementById('editor-font-select');
            if (fontSelect) fontSelect.value = this.current.editorFont;
        }
        
        // Apply font size
        if (this.current.editorFontSize) {
            this.setEditorFontSize(this.current.editorFontSize);
            const sizeSelect = document.getElementById('font-size-select');
            if (sizeSelect) sizeSelect.value = this.current.editorFontSize;
        }
        
        // Apply auto-save
        const autoSaveToggle = document.getElementById('auto-save-toggle');
        if (autoSaveToggle) {
            autoSaveToggle.checked = this.current.autoSave !== false;
        }
    },

    // Set theme and update UI
    setTheme: function(theme) {
        this.current.theme = theme;
        document.body.setAttribute('data-theme', theme);
        
        // Update theme toggle buttons
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.theme === theme) {
                btn.classList.add('active');
            }
        });
        
        this.saveSettings();
        this.updateThemeDependentElements();
    },

    // Set editor font
    setEditorFont: function(font) {
        this.current.editorFont = font;
        document.documentElement.style.setProperty('--editor-font', font);
        
        const editor = document.getElementById('editor');
        if (editor) {
            editor.style.fontFamily = `${font}, cursive`;
        }
        
        this.saveSettings();
    },

    // Set editor font size
    setEditorFontSize: function(size) {
        this.current.editorFontSize = size;
        document.documentElement.style.setProperty('--editor-font-size', size + 'px');
        
        const editor = document.getElementById('editor');
        if (editor) {
            editor.style.fontSize = size + 'px';
        }
        
        this.saveSettings();
    },

    // Update elements that depend on theme
    updateThemeDependentElements: function() {
        // Update color swatches border for light theme
        const colorSwatches = document.querySelectorAll('.color-swatch');
        colorSwatches.forEach(swatch => {
            if (this.current.theme === 'light') {
                swatch.style.borderColor = '#ccc';
            } else {
                swatch.style.borderColor = '#333';
            }
        });
    },

    // Bind event listeners
    bindEvents: function() {
        // Theme toggle buttons
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const theme = e.currentTarget.dataset.theme;
                this.setTheme(theme);
            });
        });
        
        // Editor font select
        const fontSelect = document.getElementById('editor-font-select');
        if (fontSelect) {
            fontSelect.addEventListener('change', (e) => {
                this.setEditorFont(e.target.value);
            });
        }
        
        // Font size select
        const sizeSelect = document.getElementById('font-size-select');
        if (sizeSelect) {
            sizeSelect.addEventListener('change', (e) => {
                this.setEditorFontSize(e.target.value);
            });
        }
        
        // Auto-save toggle
        const autoSaveToggle = document.getElementById('auto-save-toggle');
        if (autoSaveToggle) {
            autoSaveToggle.addEventListener('change', (e) => {
                this.current.autoSave = e.target.checked;
                this.saveSettings();
            });
        }
    },

    // Export settings for other modules
    getSettings: function() {
        return { ...this.current };
    },

    // Reset to defaults
    resetToDefaults: function() {
        this.current = { ...this.defaults };
        this.applySettings();
        this.saveSettings();
    }
};

// Initialize settings when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    Settings.init();
});

// Add settings-related functions to UI object
if (typeof UI !== 'undefined') {
    // Extend UI with settings modal functions
    UI.openSettingsModal = function() {
        const overlay = document.getElementById('settings-modal-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = '1', 10);
        }
    };

    UI.closeSettingsModal = function() {
        const overlay = document.getElementById('settings-modal-overlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 300);
        }
    };

    // Extend modal handling to include settings
    const originalOpenModal = UI.openModal;
    UI.openModal = function(mode, titleOrId, msgOrLabel = null, callback = null) {
        if (mode === 'settings') {
            UI.openSettingsModal();
        } else {
            originalOpenModal.call(this, mode, titleOrId, msgOrLabel, callback);
        }
    };
}

// Add folder system functionality
const Folders = {
    folders: [],
    currentFolder: 'all',

    init: function() {
        this.loadFolders();
        this.renderFolders();
    },

    loadFolders: function() {
        const saved = localStorage.getItem('focuspad_folders');
        if (saved) {
            try {
                this.folders = JSON.parse(saved);
            } catch (e) {
                this.folders = [
                    { id: 'all', name: 'All Notes', icon: 'ph-note' },
                    { id: 'pinned', name: 'Pinned', icon: 'ph-push-pin' },
                    { id: 'work', name: 'Work', icon: 'ph-briefcase' },
                    { id: 'personal', name: 'Personal', icon: 'ph-user' }
                ];
            }
        } else {
            this.folders = [
                { id: 'all', name: 'All Notes', icon: 'ph-note' },
                { id: 'pinned', name: 'Pinned', icon: 'ph-push-pin' },
                { id: 'work', name: 'Work', icon: 'ph-briefcase' },
                { id: 'personal', name: 'Personal', icon: 'ph-user' }
            ];
        }
    },

    saveFolders: function() {
        localStorage.setItem('focuspad_folders', JSON.stringify(this.folders));
    },

    renderFolders: function() {
        const foldersList = document.getElementById('folders-list');
        if (!foldersList) return;

        foldersList.innerHTML = '';
        
        this.folders.forEach(folder => {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            if (folder.id === this.currentFolder) {
                folderItem.classList.add('active');
            }
            
            folderItem.innerHTML = `
                <i class="ph ${folder.icon}"></i>
                <span class="folder-name">${folder.name}</span>
            `;
            
            folderItem.onclick = () => {
                this.setCurrentFolder(folder.id);
                if (typeof UI !== 'undefined' && UI.renderNotesList) {
                    UI.renderNotesList();
                }
            };
            
            foldersList.appendChild(folderItem);
        });
    },

    setCurrentFolder: function(folderId) {
        this.currentFolder = folderId;
        this.renderFolders();
    },

    getCurrentFolder: function() {
        return this.currentFolder;
    },

    getNotesByFolder: function(notes) {
        if (this.currentFolder === 'all') {
            return notes;
        } else if (this.currentFolder === 'pinned') {
            return notes.filter(note => note.is_pinned);
        } else {
            // For custom folders, we would filter by folder ID
            // This requires adding folder_id to notes
            return notes; // Placeholder
        }
    },

    addFolder: function(name, icon = 'ph-folder') {
        const newFolder = {
            id: 'folder_' + Date.now(),
            name: name,
            icon: icon
        };
        
        this.folders.push(newFolder);
        this.saveFolders();
        this.renderFolders();
    },

    removeFolder: function(folderId) {
        this.folders = this.folders.filter(f => f.id !== folderId);
        this.saveFolders();
        this.renderFolders();
    }
};

// Initialize folders when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    Folders.init();
});

// Update Store.getFilteredNotes to consider folders
const originalGetFilteredNotes = Store.getFilteredNotes;
Store.getFilteredNotes = function() {
    const notes = originalGetFilteredNotes.call(this);
    return Folders.getNotesByFolder(notes);
};

// Update UI.renderChips to work with folders
const originalRenderChips = UI.renderChips;
UI.renderChips = function() {
    // Save current active ID before filtering
    const activeId = Store.activeId;
    
    // Get filtered notes
    const notes = Store.getFilteredNotes();
    
    // If active note is not in filtered list, select first note
    if (activeId && !notes.find(n => n.id === activeId)) {
        if (notes.length > 0) {
            Store.activeId = notes[0].id;
            this.loadNoteContent();
        } else {
            Store.activeId = null;
        }
    }
    
    // Call original renderChips
    originalRenderChips.call(this);
};

// Update UI.renderNotesList to work with folders
const originalRenderNotesList = UI.renderNotesList;
UI.renderNotesList = function() {
    const notesList = document.getElementById('notes-list');
    if (!notesList) return;

    notesList.innerHTML = "";
    const notes = Store.getFilteredNotes();

    let currentGroup = null;

    notes.forEach(note => {
        // Determine Group
        const date = new Date(note.updated_at || note.created_at || Date.now());
        let group = "";

        if (this.isToday(date)) group = "Today";
        else if (this.isYesterday(date)) group = "Yesterday";
        else group = this.formatDateGroup(date);

        // Render Header if group changes
        if (group !== currentGroup) {
            const header = document.createElement('div');
            header.className = 'sidebar-date-header';
            header.innerText = group;
            notesList.appendChild(header);
            currentGroup = group;
        }

        // Render Note Item
        const item = document.createElement('div');
        item.className = "note-item";
        if (note.id == Store.activeId) item.classList.add("active");
        if (note.is_pinned) item.classList.add("pinned");

        item.innerHTML = `
            <i class="ph ${note.is_pinned ? 'ph-push-pin' : 'ph-note'}"></i>
            <span class="note-title">${note.title}</span>
        `;

        item.onclick = () => {
            Logic.switchNote(note.id);
            if (window.innerWidth < 769) {
                UI.toggleSidebar();
            }
        };

        notesList.appendChild(item);
    });
};